<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mbtech - Event Manager</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Emmy-Kingz/mbtech.ng/main/favicon.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            blue: '#0056b3',
                            dark: '#0f172a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 font-sans text-slate-900">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Calendar, CalendarPlus, Trash2, LogOut, ShieldAlert, 
            X, CheckCircle, Image as ImageIcon, Github, ExternalLink, Loader2, ArrowLeft
        } from 'lucide-react';

        // --- FIREBASE CONFIG ---
        import { initializeApp } from 'firebase/app';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from 'firebase/auth';
        import { getFirestore, collection, addDoc, serverTimestamp, doc, deleteDoc, onSnapshot, initializeFirestore } from 'firebase/firestore';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'firebase/storage';

        const firebaseConfig = {
            apiKey: "AIzaSyDRkEVsI2swGV5cgn_0gMHTIWUbLhsacfY",
            authDomain: "mbtechstore-17984.firebaseapp.com",
            projectId: "mbtechstore-17984",
            storageBucket: "mbtechstore-17984.firebasestorage.app",
            messagingSenderId: "1083008774596",
            appId: "1:1083008774596:web:110b651c6426116ed43491"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const db = initializeFirestore(app, { experimentalForceLongPolling: true });
        
        const appId = 'mbtech-public-store'; // Keeping the same data scope as the store
        const ADMIN_EMAIL = "emmanuel.amobi03@gmail.com";
        const GITHUB_PRODUCT_IMG_BASE = "https://raw.githubusercontent.com/Emmy-Kingz/mbtech.ng/main/products-img/";

        // --- NOTIFICATION COMPONENT ---
        const Notification = ({ msg, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, []);
            return (
                <div className={`fixed top-4 right-4 z-[70] px-6 py-3 rounded-lg shadow-xl text-white flex items-center gap-2 animate-bounce ${type==='error'?'bg-red-600':'bg-brand-blue'}`}>
                    {type==='error'?<X size={18}/>:<CheckCircle size={18}/>} {msg}
                </div>
            );
        };

        // --- AUTH/LOGIN SCREEN ---
        const LoginScreen = ({ notify }) => {
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await signInWithEmailAndPassword(auth, e.target[0].value, e.target[1].value);
                } catch (err) {
                    notify("Invalid credentials.", "error");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
                        <div className="flex justify-center mb-6">
                            <div className="w-16 h-16 bg-brand-blue rounded-xl flex items-center justify-center text-white shadow-lg">
                                <Calendar size={32} />
                            </div>
                        </div>
                        <h1 className="text-2xl font-black text-center text-brand-dark mb-2">Event Manager</h1>
                        <p className="text-center text-slate-500 text-sm mb-8">Restricted access. Authorized admins only.</p>
                        
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="email" placeholder="Admin Email" required className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-brand-blue" />
                            <input type="password" placeholder="Password" required className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-brand-blue" />
                            <button disabled={loading} type="submit" className="w-full py-4 bg-brand-blue text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all disabled:opacity-70 flex justify-center">
                                {loading ? <Loader2 className="animate-spin" /> : "Secure Login"}
                            </button>
                        </form>
                        <a href="index.html" className="block text-center mt-6 text-sm text-slate-500 hover:text-brand-blue flex items-center justify-center gap-1">
                            <ArrowLeft size={14}/> Back to Main Site
                        </a>
                    </div>
                </div>
            );
        };

        // --- DASHBOARD COMPONENT ---
        const Dashboard = ({ user, notify }) => {
            const [events, setEvents] = useState([]);
            const [newEvent, setNewEvent] = useState({ title: '', date: '', location: '', description: '', image: '' });
            const [imageSource, setImageSource] = useState('upload');
            const [uploading, setUploading] = useState(false);

            useEffect(() => {
                const unsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_events'), (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    // Sort newest first based on creation date
                    setEvents(data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
                });
                return () => unsub();
            }, []);

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 1024 * 1024) {
                    notify("File too large! Max 1MB.", "error");
                    e.target.value = null;
                    return;
                }
                setUploading(true);
                try {
                    const storageRef = ref(storage, `events-img/${file.name}`);
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);
                    setNewEvent({...newEvent, image: url});
                    notify("Image Uploaded");
                } catch (error) {
                    notify("Upload Failed", "error");
                } finally {
                    setUploading(false);
                }
            };

            const handleAddEvent = async (e) => {
                e.preventDefault();
                let finalImage = newEvent.image;
                if (imageSource === 'github') {
                    finalImage = `${GITHUB_PRODUCT_IMG_BASE}${newEvent.image}`;
                }
                
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_events'), {
                        ...newEvent, 
                        image: finalImage,
                        createdAt: serverTimestamp()
                    });
                    setNewEvent({ title: '', date: '', location: '', description: '', image: '' });
                    notify("Event Successfully Published!");
                } catch (error) {
                    notify("Failed to add event.", "error");
                }
            };

            const handleDelete = async (id) => {
                if(!confirm("Are you sure you want to delete this event?")) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_events', id));
                    notify("Event Deleted");
                } catch (error) {
                    notify("Failed to delete.", "error");
                }
            };

            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <nav className="bg-brand-dark text-white p-4 shadow-lg sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-brand-blue rounded-lg flex items-center justify-center font-bold text-xl shadow">M</div>
                                <div>
                                    <h1 className="font-black leading-none">Mbtech Events</h1>
                                    <span className="text-[10px] text-blue-300 tracking-widest uppercase">Admin Portal</span>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <span className="hidden sm:block text-sm text-slate-400">{user.email}</span>
                                <button onClick={() => signOut(auth)} className="flex items-center gap-2 px-4 py-2 bg-white/10 rounded-lg hover:bg-red-500 hover:text-white transition-colors text-sm font-bold">
                                    <LogOut size={16}/> Logout
                                </button>
                            </div>
                        </div>
                    </nav>

                    <div className="max-w-7xl mx-auto px-4 py-8 grid lg:grid-cols-3 gap-8">
                        {/* Event Form */}
                        <div className="lg:col-span-1">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 sticky top-28">
                                <h2 className="text-xl font-black text-brand-dark mb-6 flex items-center gap-2">
                                    <CalendarPlus size={24} className="text-brand-blue"/> Publish Event
                                </h2>
                                <form onSubmit={handleAddEvent} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase">Event Title</label>
                                        <input required value={newEvent.title} onChange={e=>setNewEvent({...newEvent, title:e.target.value})} className="w-full mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-brand-blue" placeholder="e.g. Tech Bootcamp Cohort 5" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase">Short Date</label>
                                            <input required value={newEvent.date} onChange={e=>setNewEvent({...newEvent, date:e.target.value})} className="w-full mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-brand-blue" placeholder="e.g. Mar 15" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase">Location/Type</label>
                                            <input required value={newEvent.location} onChange={e=>setNewEvent({...newEvent, location:e.target.value})} className="w-full mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-brand-blue" placeholder="e.g. Virtual, Lagos" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase">Description</label>
                                        <textarea required value={newEvent.description} onChange={e=>setNewEvent({...newEvent, description:e.target.value})} rows="3" className="w-full mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-brand-blue resize-none" placeholder="Brief details about the event..."></textarea>
                                    </div>
                                    
                                    <div className="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                        <label className="text-xs font-bold text-slate-800 block mb-3">Cover Image Source</label>
                                        <div className="flex gap-2 mb-3">
                                            <button type="button" onClick={() => setImageSource('upload')} className={`flex-1 py-1.5 text-xs rounded-md border font-bold transition-colors ${imageSource === 'upload' ? 'bg-white border-brand-blue text-brand-blue shadow-sm' : 'bg-slate-100 text-slate-500 border-transparent'}`}>Upload</button>
                                            <button type="button" onClick={() => setImageSource('github')} className={`flex-1 py-1.5 text-xs rounded-md border font-bold transition-colors ${imageSource === 'github' ? 'bg-white border-brand-blue text-brand-blue shadow-sm' : 'bg-slate-100 text-slate-500 border-transparent'}`}>GitHub</button>
                                            <button type="button" onClick={() => setImageSource('url')} className={`flex-1 py-1.5 text-xs rounded-md border font-bold transition-colors ${imageSource === 'url' ? 'bg-white border-brand-blue text-brand-blue shadow-sm' : 'bg-slate-100 text-slate-500 border-transparent'}`}>URL Link</button>
                                        </div>

                                        {imageSource === 'upload' && (
                                            <div className="relative">
                                                <input type="file" accept="image/*" onChange={handleImageUpload} className="w-full text-xs text-slate-500 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-blue-100 file:text-brand-blue hover:file:bg-blue-200 cursor-pointer"/>
                                                {uploading && <div className="text-xs text-brand-blue mt-2 flex items-center gap-1"><Loader2 size={12} className="animate-spin"/> Uploading to Cloud...</div>}
                                                {newEvent.image && !uploading && <div className="text-xs text-green-600 mt-2 font-medium truncate">âœ“ Image Ready</div>}
                                            </div>
                                        )}
                                        {imageSource === 'github' && (
                                            <div className="relative">
                                                <input placeholder="filename.jpg" className="w-full border p-3 rounded-lg text-sm pl-10 outline-none focus:border-brand-blue" value={newEvent.image} onChange={e=>setNewEvent({...newEvent, image: e.target.value})} required={imageSource === 'github'}/>
                                                <Github size={16} className="absolute top-3.5 left-3 text-slate-400"/>
                                                <div className="text-[10px] text-slate-400 mt-2 leading-tight">Will load from: <br/><span className="text-brand-blue font-mono">/products-img/{newEvent.image || '...'}</span></div>
                                            </div>
                                        )}
                                        {imageSource === 'url' && (
                                            <div className="relative">
                                                <input placeholder="https://example.com/img.jpg" className="w-full border p-3 rounded-lg text-sm pl-10 outline-none focus:border-brand-blue" value={newEvent.image} onChange={e=>setNewEvent({...newEvent, image: e.target.value})} required={imageSource === 'url'}/>
                                                <ExternalLink size={16} className="absolute top-3.5 left-3 text-slate-400"/>
                                            </div>
                                        )}
                                    </div>

                                    <button disabled={uploading} type="submit" className="w-full py-4 bg-brand-dark text-white font-black rounded-xl hover:bg-slate-800 transition-colors disabled:opacity-50 mt-4">
                                        {uploading ? 'Processing...' : 'Publish Event'}
                                    </button>
                                </form>
                            </div>
                        </div>

                        {/* Event List */}
                        <div className="lg:col-span-2">
                            <h2 className="text-xl font-black text-brand-dark mb-6 flex items-center justify-between">
                                Active Events
                                <span className="bg-blue-100 text-brand-blue text-xs px-3 py-1 rounded-full">{events.length} Total</span>
                            </h2>
                            
                            {events.length === 0 ? (
                                <div className="bg-white rounded-2xl border border-slate-200 border-dashed p-12 text-center flex flex-col items-center">
                                    <Calendar size={48} className="text-slate-300 mb-4" />
                                    <h3 className="text-lg font-bold text-slate-700">No events currently active</h3>
                                    <p className="text-sm text-slate-500 mt-1">Use the form to publish your first upcoming event.</p>
                                </div>
                            ) : (
                                <div className="grid sm:grid-cols-2 gap-6">
                                    {events.map(ev => (
                                        <div key={ev.id} className="bg-white border border-slate-200 rounded-3xl p-2 shadow-sm flex flex-col relative group">
                                            {/* Delete Overlay Button */}
                                            <button onClick={() => handleDelete(ev.id)} className="absolute top-4 right-4 z-10 bg-red-500 text-white p-2 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600" title="Delete Event">
                                                <Trash2 size={16} />
                                            </button>
                                            
                                            <div className="relative bg-slate-900 rounded-2xl h-40 overflow-hidden">
                                                <img src={ev.image} className="w-full h-full object-cover opacity-90" onError={(e)=>{e.target.src='https://placehold.co/800x400?text=No+Image'}} />
                                                <div className="absolute top-3 left-3 bg-white text-slate-900 px-3 py-1 rounded-lg text-xs font-black shadow-md">{ev.date}</div>
                                            </div>
                                            <div className="p-5 flex-grow flex flex-col">
                                                <h3 className="text-md font-bold text-slate-900 mb-2 leading-tight">{ev.title}</h3>
                                                <p className="text-slate-500 text-xs mb-4 flex-grow line-clamp-3 leading-relaxed">{ev.description}</p>
                                                <div className="flex items-center justify-between border-t border-slate-100 pt-3 mt-auto">
                                                    <span className="text-[11px] text-slate-500 font-bold flex items-center gap-1 uppercase tracking-wider bg-slate-100 px-2 py-1 rounded">
                                                        {ev.location}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ROOT APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [notification, setNotification] = useState(null);

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            const notify = (msg, type='success') => {
                setNotification({ msg, type });
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center"><Loader2 size={40} className="animate-spin text-brand-blue"/></div>;

            return (
                <>
                    {notification && <Notification msg={notification.msg} type={notification.type} onClose={() => setNotification(null)} />}
                    
                    {!user ? (
                        <LoginScreen notify={notify} />
                    ) : user.email !== ADMIN_EMAIL ? (
                        <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-slate-100">
                            <div className="bg-white p-8 rounded-2xl shadow-lg max-w-sm w-full text-center">
                                <ShieldAlert size={48} className="text-red-500 mx-auto mb-4" />
                                <h1 className="text-xl font-bold text-slate-900 mb-2">Access Denied</h1>
                                <p className="text-slate-500 text-sm mb-6">You are logged in as <b className="text-slate-700">{user.email}</b>, which does not have Admin privileges.</p>
                                <button onClick={() => signOut(auth)} className="w-full py-3 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 transition-colors">Sign Out</button>
                            </div>
                        </div>
                    ) : (
                        <Dashboard user={user} notify={notify} />
                    )}
                </>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
