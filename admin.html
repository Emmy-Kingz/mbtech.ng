<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mbtech Admin Portal</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Emmy-Kingz/mbtech.ng/main/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        emerald: {
                            50: '#ecfdf5', 100: '#d1fae5', 400: '#34d399',
                            500: '#10b981', 600: '#059669', 700: '#047857',
                            800: '#065f46', 900: '#064e3b',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 font-sans text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            LayoutDashboard, Package, ShoppingCart, Users, Settings, 
            LogOut, Plus, Search, Trash2, Edit, CheckCircle, Clock, 
            AlertTriangle, Truck, Eye, X, Image as ImageIcon, Loader2,
            DollarSign, TrendingUp, Archive, Star
        } from 'lucide-react';

        // --- FIREBASE IMPORTS & SETUP ---
        import { initializeApp } from 'firebase/app';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from 'firebase/auth';
        import { getFirestore, collection, addDoc, serverTimestamp, doc, deleteDoc, updateDoc, onSnapshot, initializeFirestore } from 'firebase/firestore';

        const firebaseConfig = {
            apiKey: "AIzaSyDRkEVsI2swGV5cgn_0gMHTIWUbLhsacfY",
            authDomain: "mbtechstore-17984.firebaseapp.com",
            projectId: "mbtechstore-17984",
            storageBucket: "mbtechstore-17984.firebasestorage.app",
            messagingSenderId: "1083008774596",
            appId: "1:1083008774596:web:110b651c6426116ed43491"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = initializeFirestore(app, { experimentalForceLongPolling: true });
        const appId = 'mbtech-public-store';

        // --- CONSTANTS ---
        const ADMIN_EMAILS = ["emmanuel.amobi03@gmail.com", "mesobest2000@gmail.com", "mesobest.technology.org@gmail.com"];
        const CATEGORIES = ["Solar & Energy", "Gadgets", "Electricals", "Software", "Services"];
        
        // --- COMPONENTS ---
        
        // Modal for Adding Products
        const ProductModal = ({ isOpen, onClose, onSave }) => {
            const [form, setForm] = useState({ name: '', price: '', category: 'Gadgets', stock: '', image: '', type: 'good', featured: false });

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({
                    ...form,
                    price: Number(form.price),
                    stock: Number(form.stock) || 0,
                    rating: 5
                });
                setForm({ name: '', price: '', category: 'Gadgets', stock: '', image: '', type: 'good', featured: false });
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-700"><X size={20}/></button>
                        <h2 className="text-xl font-bold mb-6">Add New Product</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Product Name</label>
                                <input required type="text" className="w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none" value={form.name} onChange={e=>setForm({...form, name: e.target.value})} placeholder="e.g. 5KVA Inverter" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Price (₦)</label>
                                    <input required type="number" min="0" className="w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none" value={form.price} onChange={e=>setForm({...form, price: e.target.value})} placeholder="0.00" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Initial Stock</label>
                                    <input required type="number" min="0" className="w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none" value={form.stock} onChange={e=>setForm({...form, stock: e.target.value})} placeholder="Qty" />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Category</label>
                                    <select className="w-full border rounded-lg p-2.5 outline-none" value={form.category} onChange={e=>setForm({...form, category: e.target.value})}>
                                        {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Type</label>
                                    <select className="w-full border rounded-lg p-2.5 outline-none" value={form.type} onChange={e=>setForm({...form, type: e.target.value})}>
                                        <option value="good">Physical Good</option>
                                        <option value="service">Service/Installation</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Image URL</label>
                                <input required type="url" className="w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none text-sm" value={form.image} onChange={e=>setForm({...form, image: e.target.value})} placeholder="https://..." />
                            </div>
                            <div className="flex items-center gap-2 mt-4 p-3 bg-emerald-50 rounded-lg border border-emerald-100">
                                <input type="checkbox" id="featured" checked={form.featured} onChange={e=>setForm({...form, featured: e.target.checked})} className="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500 cursor-pointer" />
                                <label htmlFor="featured" className="text-sm font-bold text-slate-700 cursor-pointer flex items-center gap-1"><Star size={16} className="text-yellow-500" fill="currentColor"/> Set as Featured Product</label>
                            </div>
                            <button type="submit" className="w-full py-3 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 transition-colors mt-4">
                                Save Product
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // Order Details Modal
        const OrderModal = ({ order, isOpen, onClose, onUpdateStatus }) => {
            if (!isOpen || !order) return null;

            const total = order.total || 0;
            const statuses = ['pending', 'processing', 'shipped', 'delivered', 'cancelled'];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 shadow-2xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-700"><X size={20}/></button>
                        
                        <div className="flex justify-between items-start mb-6 border-b pb-4">
                            <div>
                                <h2 className="text-xl font-bold text-slate-900">Order #{order.id.slice(0,8).toUpperCase()}</h2>
                                <p className="text-sm text-slate-500">{new Date(order.createdAt?.seconds * 1000).toLocaleString()}</p>
                            </div>
                            <div className="text-right">
                                <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider
                                    ${order.status === 'delivered' ? 'bg-green-100 text-green-700' : 
                                      order.status === 'shipped' ? 'bg-purple-100 text-purple-700' : 
                                      order.status === 'processing' ? 'bg-blue-100 text-blue-700' : 
                                      order.status === 'cancelled' ? 'bg-red-100 text-red-700' : 
                                      'bg-yellow-100 text-yellow-700'}`}>
                                    {order.status}
                                </span>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6 mb-8">
                            <div className="bg-slate-50 p-4 rounded-xl">
                                <h3 className="text-sm font-bold text-slate-800 mb-2 flex items-center gap-2"><Users size={16}/> Customer Details</h3>
                                <p className="text-sm font-medium">{order.userName}</p>
                                <p className="text-sm text-slate-600">{order.contact || 'No phone provided'}</p>
                                <p className="text-sm text-slate-600 mt-2 whitespace-pre-wrap">{order.address || 'No address provided'}</p>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-xl">
                                <h3 className="text-sm font-bold text-slate-800 mb-2 flex items-center gap-2"><Settings size={16}/> Management Action</h3>
                                <label className="block text-xs text-slate-500 mb-1">Update Status:</label>
                                <select 
                                    className="w-full border rounded p-2 text-sm outline-none bg-white focus:ring-2 focus:ring-emerald-500"
                                    value={order.status}
                                    onChange={(e) => onUpdateStatus(order.id, e.target.value)}
                                >
                                    {statuses.map(s => <option key={s} value={s}>{s.charAt(0).toUpperCase() + s.slice(1)}</option>)}
                                </select>
                                <div className="mt-4 pt-4 border-t border-slate-200">
                                    <p className="text-xs text-slate-500">Payment Method</p>
                                    <p className="text-sm font-bold uppercase">{order.method || 'Unknown'}</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 className="font-bold text-slate-800 mb-3 border-b pb-2">Order Items</h3>
                            <div className="space-y-3 mb-6">
                                {(order.items || []).map((item, idx) => (
                                    <div key={idx} className="flex justify-between items-center bg-slate-50 p-3 rounded-lg">
                                        <div className="flex items-center gap-3">
                                            <img src={item.image} alt={item.name} className="w-12 h-12 object-cover rounded bg-white border"/>
                                            <div>
                                                <p className="text-sm font-bold">{item.name}</p>
                                                <p className="text-xs text-slate-500">₦{item.price?.toLocaleString()} x {item.qty}</p>
                                            </div>
                                        </div>
                                        <div className="font-bold text-sm">
                                            ₦{(item.price * item.qty).toLocaleString()}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="flex justify-between items-center text-xl font-bold bg-emerald-50 text-emerald-900 p-4 rounded-xl">
                                <span>Total Amount:</span>
                                <span>₦{total.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Main App
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('dashboard');
            const [products, setProducts] = useState([]);
            const [orders, setOrders] = useState([]);
            const [recs, setRecs] = useState([]);
            
            // Modal States
            const [isProductModalOpen, setProductModalOpen] = useState(false);
            const [selectedOrder, setSelectedOrder] = useState(null);

            // Login State
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loginError, setLoginError] = useState('');

            useEffect(() => {
                const unsubAuth = onAuthStateChanged(auth, (u) => {
                    if (u && ADMIN_EMAILS.includes(u.email)) {
                        setUser(u);
                    } else {
                        setUser(null);
                        if (u) signOut(auth); // Sign out unauthorized users
                    }
                    setLoading(false);
                });
                return () => unsubAuth();
            }, []);

            useEffect(() => {
                if (!user) return;
                
                const qP = collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_products');
                const qO = collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_orders');
                const qR = collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_recommendations');
                
                const uP = onSnapshot(qP, s => {
                    const data = s.docs.map(d=>({id:d.id,...d.data()}));
                    setProducts(data);
                });
                const uO = onSnapshot(qO, s => {
                    const data = s.docs.map(d=>({id:d.id,...d.data()}));
                    data.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setOrders(data);
                });
                const uR = onSnapshot(qR, s => setRecs(s.docs.map(d=>({id:d.id,...d.data()}))));
                
                return () => { uP(); uO(); uR(); };
            }, [user]);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoginError('');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setLoginError("Invalid admin credentials.");
                }
            };

            const handleAddProduct = async (productData) => {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_products'), productData);
                    setProductModalOpen(false);
                } catch (e) {
                    alert("Error adding product");
                }
            };

            const handleDeleteProduct = async (id) => {
                if(confirm("Are you sure you want to delete this product?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_products', id));
                }
            };

            const updateStock = async (id, newStock) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_products', id), { stock: Number(newStock) });
            };

            const updateOrderStatus = async (orderId, newStatus) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_orders', orderId), { status: newStatus });
                    setSelectedOrder(prev => prev ? {...prev, status: newStatus} : null);
                } catch (e) {
                    alert("Failed to update status.");
                }
            };

            const toggleFeatured = async (id, currentStatus) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_products', id), { featured: !currentStatus });
                } catch (e) {
                    alert("Failed to update featured status.");
                }
            };

            // Calculated Stats
            const stats = useMemo(() => {
                const totalRevenue = orders.filter(o => o.status === 'delivered').reduce((sum, o) => sum + (o.total || 0), 0);
                const pendingOrders = orders.filter(o => o.status === 'pending').length;
                const lowStockItems = products.filter(p => p.type !== 'service' && p.stock < 5).length;
                return { totalRevenue, pendingOrders, lowStockItems, totalProducts: products.length };
            }, [orders, products]);

            if (loading) return <div className="min-h-screen flex items-center justify-center"><Loader2 size={40} className="animate-spin text-emerald-600"/></div>;

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 p-4">
                        <div className="bg-white p-8 rounded-2xl w-full max-w-sm shadow-2xl">
                            <div className="text-center mb-8">
                                <div className="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Settings size={32} className="text-emerald-600" />
                                </div>
                                <h1 className="text-2xl font-bold text-slate-900">Admin Portal</h1>
                                <p className="text-sm text-slate-500">Mbtech Store Management</p>
                            </div>
                            <form onSubmit={handleLogin} className="space-y-4">
                                {loginError && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100">{loginError}</div>}
                                <div>
                                    <label className="block text-xs font-bold text-slate-600 mb-1">Admin Email</label>
                                    <input type="email" value={email} onChange={e=>setEmail(e.target.value)} required className="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-emerald-500 bg-slate-50"/>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-600 mb-1">Password</label>
                                    <input type="password" value={password} onChange={e=>setPassword(e.target.value)} required className="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-emerald-500 bg-slate-50"/>
                                </div>
                                <button type="submit" className="w-full py-3 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 transition-colors pt-4">Access Portal</button>
                            </form>
                            <div className="mt-6 text-center">
                                <a href="store.html" className="text-sm text-emerald-600 hover:underline">&larr; Back to Store</a>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen bg-slate-50 overflow-hidden">
                    {/* Sidebar */}
                    <aside className="w-64 bg-slate-900 text-slate-300 flex flex-col hidden md:flex">
                        <div className="p-6 border-b border-slate-800">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                <div className="p-1.5 bg-emerald-500 rounded text-white"><LayoutDashboard size={18}/></div>
                                Mbtech Admin
                            </h2>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            <button onClick={()=>setView('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${view==='dashboard'?'bg-emerald-600 text-white':'hover:bg-slate-800'}`}><TrendingUp size={18}/> Dashboard</button>
                            <button onClick={()=>setView('products')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${view==='products'?'bg-emerald-600 text-white':'hover:bg-slate-800'}`}><Package size={18}/> Products & Stock</button>
                            <button onClick={()=>setView('orders')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${view==='orders'?'bg-emerald-600 text-white':'hover:bg-slate-800'}`}>
                                <ShoppingCart size={18}/> Orders 
                                {stats.pendingOrders > 0 && <span className="ml-auto bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full">{stats.pendingOrders}</span>}
                            </button>
                            <button onClick={()=>setView('requests')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${view==='requests'?'bg-emerald-600 text-white':'hover:bg-slate-800'}`}><Users size={18}/> Customer Requests</button>
                        </nav>
                        <div className="p-4 border-t border-slate-800">
                            <div className="text-xs mb-3 text-slate-500">Logged in as: <br/><span className="text-white truncate block">{user.email}</span></div>
                            <button onClick={()=>signOut(auth)} className="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-800 hover:bg-red-500 hover:text-white rounded-lg transition-colors"><LogOut size={16}/> Sign Out</button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col h-screen overflow-y-auto">
                        <header className="bg-white border-b px-8 py-4 flex justify-between items-center sticky top-0 z-30">
                            <h1 className="text-2xl font-bold text-slate-800 capitalize">{view}</h1>
                            <div className="flex gap-4">
                                <a href="store.html" target="_blank" className="text-sm font-medium text-emerald-600 hover:text-emerald-700 flex items-center gap-1">View Store <Eye size={16}/></a>
                            </div>
                        </header>

                        <div className="p-8">
                            {/* DASHBOARD VIEW */}
                            {view === 'dashboard' && (
                                <div className="space-y-8 animate-in fade-in">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                                            <div className="p-4 bg-emerald-50 text-emerald-600 rounded-xl"><DollarSign size={24}/></div>
                                            <div>
                                                <p className="text-sm text-slate-500 font-medium">Delivered Revenue</p>
                                                <p className="text-2xl font-bold text-slate-900">₦{stats.totalRevenue.toLocaleString()}</p>
                                            </div>
                                        </div>
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                                            <div className="p-4 bg-yellow-50 text-yellow-600 rounded-xl"><Clock size={24}/></div>
                                            <div>
                                                <p className="text-sm text-slate-500 font-medium">Pending Orders</p>
                                                <p className="text-2xl font-bold text-slate-900">{stats.pendingOrders}</p>
                                            </div>
                                        </div>
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                                            <div className="p-4 bg-red-50 text-red-600 rounded-xl"><AlertTriangle size={24}/></div>
                                            <div>
                                                <p className="text-sm text-slate-500 font-medium">Low Stock Items</p>
                                                <p className="text-2xl font-bold text-slate-900">{stats.lowStockItems}</p>
                                            </div>
                                        </div>
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                                            <div className="p-4 bg-blue-50 text-blue-600 rounded-xl"><Archive size={24}/></div>
                                            <div>
                                                <p className="text-sm text-slate-500 font-medium">Total Catalog</p>
                                                <p className="text-2xl font-bold text-slate-900">{stats.totalProducts}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Clock className="text-slate-400"/> Recent Orders</h3>
                                            <div className="space-y-3">
                                                {orders.slice(0, 5).map(o => (
                                                    <div key={o.id} className="flex justify-between items-center p-3 hover:bg-slate-50 rounded-lg cursor-pointer border border-transparent hover:border-slate-100 transition-colors" onClick={() => { setSelectedOrder(o); setView('orders'); }}>
                                                        <div>
                                                            <p className="font-bold text-sm">{o.userName}</p>
                                                            <p className="text-xs text-slate-500">#{o.id.slice(0,6)} • {new Date(o.createdAt?.seconds*1000).toLocaleDateString()}</p>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="font-bold text-sm">₦{o.total?.toLocaleString()}</p>
                                                            <span className="text-[10px] px-2 py-0.5 rounded-full bg-slate-100 uppercase font-bold text-slate-600">{o.status}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                                {orders.length === 0 && <p className="text-sm text-slate-500 text-center py-4">No recent orders</p>}
                                            </div>
                                        </div>
                                        
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-red-600"><AlertTriangle /> Low Stock Alerts</h3>
                                            <div className="space-y-3">
                                                {products.filter(p => p.type !== 'service' && p.stock < 5).map(p => (
                                                    <div key={p.id} className="flex justify-between items-center p-3 bg-red-50/50 rounded-lg border border-red-100">
                                                        <div className="flex items-center gap-3">
                                                            <img src={p.image} className="w-10 h-10 rounded bg-white object-cover border"/>
                                                            <div>
                                                                <p className="font-bold text-sm text-slate-800">{p.name}</p>
                                                                <p className="text-xs text-slate-500">{p.category}</p>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <span className="text-xs font-bold px-2 py-1 bg-red-100 text-red-700 rounded text-center block mb-1">Stock: {p.stock || 0}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                                {stats.lowStockItems === 0 && <p className="text-sm text-slate-500 text-center py-4">All stock levels are healthy</p>}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* PRODUCTS VIEW */}
                            {view === 'products' && (
                                <div className="animate-in fade-in">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-lg text-slate-500">Manage Inventory & Catalog</h2>
                                        <button onClick={() => setProductModalOpen(true)} className="flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 font-bold shadow-sm transition-colors"><Plus size={18}/> Add Product</button>
                                    </div>
                                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-slate-50 text-slate-600 border-b border-slate-200">
                                                <tr>
                                                    <th className="p-4 font-bold">Product</th>
                                                    <th className="p-4 font-bold">Category & Type</th>
                                                    <th className="p-4 font-bold">Price</th>
                                                    <th className="p-4 font-bold">Stock</th>
                                                    <th className="p-4 font-bold text-right">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {products.map(p => (
                                                    <tr key={p.id} className="hover:bg-slate-50 transition-colors">
                                                        <td className="p-4 flex items-center gap-3">
                                                            <img src={p.image} className="w-12 h-12 rounded-lg object-cover bg-slate-100 border"/>
                                                            <span className="font-bold text-slate-800">{p.name}</span>
                                                        </td>
                                                        <td className="p-4">
                                                            <span className="block">{p.category}</span>
                                                            <span className="text-[10px] uppercase tracking-wider text-slate-400 bg-slate-100 px-2 py-0.5 rounded">{p.type}</span>
                                                        </td>
                                                        <td className="p-4 font-medium text-slate-700">₦{p.price?.toLocaleString()}</td>
                                                        <td className="p-4">
                                                            {p.type === 'service' ? (
                                                                <span className="text-slate-400 italic text-xs">N/A</span>
                                                            ) : (
                                                                <div className="flex items-center gap-2">
                                                                    <input type="number" className="w-16 p-1 border rounded text-center text-sm" value={p.stock || 0} onChange={(e) => updateStock(p.id, e.target.value)} />
                                                                    {p.stock < 5 && <AlertTriangle size={14} className="text-red-500"/>}
                                                                </div>
                                                            )}
                                                        </td>
                                                        <td className="p-4 flex justify-end gap-1">
                                                            <button onClick={() => toggleFeatured(p.id, p.featured)} className={`p-2 rounded-lg transition-colors ${p.featured ? 'text-yellow-500 hover:bg-yellow-50' : 'text-slate-300 hover:text-yellow-500 hover:bg-slate-50'}`} title={p.featured ? "Remove from Featured" : "Mark as Featured"}>
                                                                <Star size={18} fill={p.featured ? "currentColor" : "none"} />
                                                            </button>
                                                            <button onClick={() => handleDeleteProduct(p.id)} className="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={18}/></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {products.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-slate-500">No products found. Click "Add Product" to start building your catalog.</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                    <ProductModal isOpen={isProductModalOpen} onClose={() => setProductModalOpen(false)} onSave={handleAddProduct} />
                                </div>
                            )}

                            {/* ORDERS VIEW */}
                            {view === 'orders' && (
                                <div className="animate-in fade-in">
                                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-slate-50 text-slate-600 border-b border-slate-200">
                                                <tr>
                                                    <th className="p-4 font-bold">Order ID</th>
                                                    <th className="p-4 font-bold">Customer</th>
                                                    <th className="p-4 font-bold">Date</th>
                                                    <th className="p-4 font-bold">Total</th>
                                                    <th className="p-4 font-bold">Status</th>
                                                    <th className="p-4 font-bold text-right">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {orders.map(o => (
                                                    <tr key={o.id} className="hover:bg-slate-50 transition-colors">
                                                        <td className="p-4 font-mono text-xs text-slate-500">#{o.id.slice(0,8).toUpperCase()}</td>
                                                        <td className="p-4 font-medium text-slate-800">{o.userName}</td>
                                                        <td className="p-4 text-slate-500">{new Date(o.createdAt?.seconds*1000).toLocaleDateString()}</td>
                                                        <td className="p-4 font-bold text-slate-700">₦{o.total?.toLocaleString()}</td>
                                                        <td className="p-4">
                                                            <select 
                                                                className={`border rounded-full px-3 py-1 text-xs font-bold uppercase tracking-wider outline-none cursor-pointer
                                                                    ${o.status === 'delivered' ? 'bg-green-50 text-green-700 border-green-200' : 
                                                                    o.status === 'shipped' ? 'bg-purple-50 text-purple-700 border-purple-200' : 
                                                                    o.status === 'processing' ? 'bg-blue-50 text-blue-700 border-blue-200' : 
                                                                    o.status === 'cancelled' ? 'bg-red-50 text-red-700 border-red-200' : 
                                                                    'bg-yellow-50 text-yellow-700 border-yellow-200'}`}
                                                                value={o.status}
                                                                onChange={(e) => updateOrderStatus(o.id, e.target.value)}
                                                            >
                                                                <option value="pending">Pending</option>
                                                                <option value="processing">Processing</option>
                                                                <option value="shipped">Shipped</option>
                                                                <option value="delivered">Delivered</option>
                                                                <option value="cancelled">Cancelled</option>
                                                            </select>
                                                        </td>
                                                        <td className="p-4 text-right">
                                                            <button onClick={() => setSelectedOrder(o)} className="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded text-xs transition-colors">View Details</button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {orders.length === 0 && <tr><td colSpan="6" className="p-8 text-center text-slate-500">No orders yet.</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                    <OrderModal order={selectedOrder} isOpen={!!selectedOrder} onClose={() => setSelectedOrder(null)} onUpdateStatus={updateOrderStatus} />
                                </div>
                            )}

                            {/* REQUESTS VIEW */}
                            {view === 'requests' && (
                                <div className="animate-in fade-in">
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {recs.map(r => (
                                            <div key={r.id} className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col h-full">
                                                <div className="flex items-start gap-3 mb-4">
                                                    <div className="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 font-bold uppercase shrink-0">
                                                        {r.userName?.charAt(0) || 'U'}
                                                    </div>
                                                    <div>
                                                        <p className="font-bold text-slate-800">{r.userName || 'Anonymous User'}</p>
                                                        <p className="text-xs text-slate-400">{new Date(r.createdAt?.seconds*1000).toLocaleString()}</p>
                                                    </div>
                                                </div>
                                                <div className="bg-slate-50 p-4 rounded-xl flex-1 border border-slate-100">
                                                    <p className="text-sm text-slate-700 italic">"{r.description}"</p>
                                                </div>
                                                <div className="mt-4 pt-4 border-t border-slate-100 flex justify-end">
                                                    <button onClick={async () => {
                                                        if(confirm('Delete this request?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_recommendations', r.id));
                                                    }} className="text-xs text-red-500 hover:underline">Dismiss Request</button>
                                                </div>
                                            </div>
                                        ))}
                                        {recs.length === 0 && <div className="col-span-full p-12 text-center text-slate-500 bg-white rounded-2xl border border-slate-100">No customer requests currently.</div>}
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
