<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mbtech Admin Portal | Unified Dashboard</title>
    
    <!-- ========================================== -->
    <!-- SECURITY MEASURES & HEADERS                -->
    <!-- ========================================== -->
    <!-- Content Security Policy (Restricts unauthorized scripts/objects to prevent XSS) -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: blob:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https: blob:; connect-src 'self' https: wss:; font-src 'self' data: https:; object-src 'none'; base-uri 'self';">
    <!-- Prevents MIME-sniffing attacks -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <!-- Protects sensitive admin URLs from leaking in Referer headers -->
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <!-- ========================================== -->

    <!-- Favicon (Brand Consistency) -->
    <link rel="icon" type="image/png" href="favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        emerald: {
                            50: '#ecfdf5', 100: '#d1fae5', 400: '#34d399',
                            500: '#10b981', 600: '#059669', 700: '#047857',
                            800: '#065f46', 900: '#064e3b',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Mobile-friendly scrolling & layout */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Add padding to the bottom of the main content area for the mobile nav */
        main { padding-bottom: 80px; }
        @media (min-width: 768px) { main { padding-bottom: 0; } }
        /* Safe area support for iOS home indicator */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 0px); }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 selection:bg-emerald-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            LayoutDashboard, Package, ShoppingCart, Users, Settings, 
            LogOut, Plus, Search, Trash2, Edit, CheckCircle, Clock, 
            AlertTriangle, Truck, Eye, X, Image as ImageIcon, Loader2,
            DollarSign, TrendingUp, Archive, Star, Calendar, MapPin, ListChecks, Newspaper, ToggleLeft, ToggleRight, Menu
        } from 'lucide-react';

        // --- FIREBASE IMPORTS & SETUP ---
        import { initializeApp } from 'firebase/app';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from 'firebase/auth';
        import { getFirestore, collection, addDoc, serverTimestamp, doc, deleteDoc, updateDoc, onSnapshot, initializeFirestore } from 'firebase/firestore';

        const firebaseConfig = {
            apiKey: "AIzaSyDRkEVsI2swGV5cgn_0gMHTIWUbLhsacfY",
            authDomain: "mbtechstore-17984.firebaseapp.com",
            projectId: "mbtechstore-17984",
            storageBucket: "mbtechstore-17984.firebasestorage.app",
            messagingSenderId: "1083008774596",
            appId: "1:1083008774596:web:110b651c6426116ed43491"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = initializeFirestore(app, { experimentalForceLongPolling: true });
        const appId = 'mbtech-public-store';

        // --- CONSTANTS ---
        const ADMIN_EMAILS = ["emmanuel.amobi03@gmail.com", "mesobest2000@gmail.com", "mesobest.technology.org@gmail.com"];
        const CATEGORIES = ["Solar & Energy", "Gadgets", "Electricals", "Software", "Services"];
        
        // --- COMPONENTS ---
        
        // Modal for Adding Products
        const ProductModal = ({ isOpen, onClose, onSave }) => {
            const [form, setForm] = useState({ name: '', price: '', category: 'Gadgets', stock: '', image: '', type: 'good', featured: false });

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({
                    ...form,
                    price: Number(form.price),
                    stock: Number(form.stock) || 0,
                    rating: 5
                });
                setForm({ name: '', price: '', category: 'Gadgets', stock: '', image: '', type: 'good', featured: false });
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl relative animate-in zoom-in-95 duration-200">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-700 bg-slate-50 rounded-full p-1"><X size={20}/></button>
                        <h2 className="text-xl font-bold mb-6 text-slate-800">Add New Product</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Product Name</label>
                                <input required type="text" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50" value={form.name} onChange={e=>setForm({...form, name: e.target.value})} placeholder="e.g. 5KVA Inverter" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Price (₦)</label>
                                    <input required type="number" min="0" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50" value={form.price} onChange={e=>setForm({...form, price: e.target.value})} placeholder="0.00" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Initial Stock</label>
                                    <input required type="number" min="0" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50" value={form.stock} onChange={e=>setForm({...form, stock: e.target.value})} placeholder="Qty" />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Category</label>
                                    <select className="w-full border border-slate-200 rounded-lg p-2.5 outline-none bg-slate-50" value={form.category} onChange={e=>setForm({...form, category: e.target.value})}>
                                        {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Type</label>
                                    <select className="w-full border border-slate-200 rounded-lg p-2.5 outline-none bg-slate-50" value={form.type} onChange={e=>setForm({...form, type: e.target.value})}>
                                        <option value="good">Physical Good</option>
                                        <option value="service">Service/Installation</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Image URL</label>
                                <input required type="url" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none text-sm bg-slate-50" value={form.image} onChange={e=>setForm({...form, image: e.target.value})} placeholder="https://..." />
                            </div>
                            <div className="flex items-center gap-2 mt-4 p-3 bg-emerald-50 rounded-lg border border-emerald-100">
                                <input type="checkbox" id="featured" checked={form.featured} onChange={e=>setForm({...form, featured: e.target.checked})} className="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500 cursor-pointer" />
                                <label htmlFor="featured" className="text-sm font-bold text-slate-700 cursor-pointer flex items-center gap-1"><Star size={16} className="text-yellow-500" fill="currentColor"/> Set as Featured Product</label>
                            </div>
                            <button type="submit" className="w-full py-3 bg-emerald-600 text-white rounded-lg font-bold shadow-md hover:bg-emerald-700 transition-colors mt-4">
                                Save Product
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // Modal for Adding Events
        const EventModal = ({ isOpen, onClose, onSave }) => {
            const [form, setForm] = useState({ title: '', date: '', time: '', location: '', description: '', image: '', status: 'upcoming' });

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(form);
                setForm({ title: '', date: '', time: '', location: '', description: '', image: '', status: 'upcoming' });
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto no-scrollbar animate-in zoom-in-95 duration-200">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-700 bg-slate-50 rounded-full p-1"><X size={20}/></button>
                        <h2 className="text-xl font-bold mb-6 text-slate-800">Add New Event / Class</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Event Title</label>
                                <input required type="text" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50" value={form.title} onChange={e=>setForm({...form, title: e.target.value})} placeholder="e.g. Frontend Bootcamp 2026" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Date</label>
                                    <input required type="date" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50" value={form.date} onChange={e=>setForm({...form, date: e.target.value})} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Time</label>
                                    <input required type="time" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50" value={form.time} onChange={e=>setForm({...form, time: e.target.value})} />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Location</label>
                                <input required type="text" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50" value={form.location} onChange={e=>setForm({...form, location: e.target.value})} placeholder="e.g. Lagos Office / Zoom Link" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Flyer/Image URL</label>
                                <input required type="url" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50 text-sm" value={form.image} onChange={e=>setForm({...form, image: e.target.value})} placeholder="https://..." />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Description</label>
                                <textarea required className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50 resize-none h-24" value={form.description} onChange={e=>setForm({...form, description: e.target.value})} placeholder="Details about the event..." />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Status</label>
                                <select className="w-full border border-slate-200 rounded-lg p-2.5 outline-none bg-slate-50" value={form.status} onChange={e=>setForm({...form, status: e.target.value})}>
                                    <option value="upcoming">Upcoming</option>
                                    <option value="ongoing">Ongoing</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <button type="submit" className="w-full py-3 bg-emerald-600 text-white rounded-lg font-bold shadow-md hover:bg-emerald-700 transition-colors mt-4">Save Event</button>
                        </form>
                    </div>
                </div>
            );
        };

        // Modal for Adding Blog Posts / Updates
        const PostModal = ({ isOpen, onClose, onSave }) => {
            const [form, setForm] = useState({ title: '', excerpt: '', content: '', category: 'General', image: '', published: true });

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ 
                    ...form, 
                    date: new Date().toLocaleDateString(undefined, {month:'short', day:'numeric', year:'numeric'}) 
                });
                setForm({ title: '', excerpt: '', content: '', category: 'General', image: '', published: true });
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl w-full max-w-2xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto no-scrollbar animate-in zoom-in-95 duration-200">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-700 bg-slate-50 rounded-full p-1"><X size={20}/></button>
                        <h2 className="text-xl font-bold mb-6 text-slate-800">Add New Update / Post</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Title</label>
                                <input required type="text" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50" value={form.title} onChange={e=>setForm({...form, title: e.target.value})} placeholder="Post Title" />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Category</label>
                                    <select className="w-full border border-slate-200 rounded-lg p-2.5 outline-none bg-slate-50" value={form.category} onChange={e=>setForm({...form, category: e.target.value})}>
                                        <option value="General">General</option>
                                        <option value="Solar Tech">Solar Tech</option>
                                        <option value="Academy News">Academy News</option>
                                        <option value="Tech Tips">Tech Tips</option>
                                        <option value="Store Updates">Store Updates</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Featured Image URL</label>
                                    <input required type="url" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50 text-sm" value={form.image} onChange={e=>setForm({...form, image: e.target.value})} placeholder="https://..." />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Short Excerpt (Shows on Card)</label>
                                <textarea required className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50 resize-none h-16" value={form.excerpt} onChange={e=>setForm({...form, excerpt: e.target.value})} placeholder="A brief summary..." />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Full Content</label>
                                <textarea required className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50 resize-none h-40" value={form.content} onChange={e=>setForm({...form, content: e.target.value})} placeholder="Main article content..." />
                            </div>
                            <div className="flex items-center gap-2 mt-4 p-3 bg-emerald-50 rounded-lg border border-emerald-100">
                                <input type="checkbox" id="published" checked={form.published} onChange={e=>setForm({...form, published: e.target.checked})} className="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500 cursor-pointer" />
                                <label htmlFor="published" className="text-sm font-bold text-slate-700 cursor-pointer">Publish Immediately</label>
                            </div>
                            <button type="submit" className="w-full py-3 bg-emerald-600 text-white rounded-lg font-bold shadow-md hover:bg-emerald-700 transition-colors mt-4">Save Post</button>
                        </form>
                    </div>
                </div>
            );
        };

        // Event Registrations Modal
        const RegistrationsModal = ({ event, registrations, isOpen, onClose }) => {
            if (!isOpen || !event) return null;
            const eventRegs = registrations.filter(r => r.eventId === event.id);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl relative animate-in zoom-in-95 duration-200">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-700 z-10 bg-slate-50 rounded-full p-1"><X size={20}/></button>
                        
                        <div className="p-6 border-b shrink-0">
                            <h2 className="text-xl font-bold text-slate-900 pr-8">Registrations for: {event.title}</h2>
                            <p className="text-sm text-emerald-600 font-bold mt-1">Total Registered: {eventRegs.length}</p>
                        </div>
                        
                        <div className="overflow-y-auto p-6 flex-1 no-scrollbar">
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm whitespace-nowrap">
                                    <thead className="bg-slate-50 text-slate-600 border-b border-slate-200">
                                        <tr>
                                            <th className="p-3 font-bold">Name</th>
                                            <th className="p-3 font-bold">Email</th>
                                            <th className="p-3 font-bold">Phone</th>
                                            <th className="p-3 font-bold">Date Registered</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {eventRegs.map(r => (
                                            <tr key={r.id} className="hover:bg-slate-50">
                                                <td className="p-3 font-medium text-slate-800">{r.name}</td>
                                                <td className="p-3 text-slate-600">{r.email}</td>
                                                <td className="p-3 text-slate-600">{r.phone}</td>
                                                <td className="p-3 text-slate-500">{r.createdAt?.seconds ? new Date(r.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                                            </tr>
                                        ))}
                                        {eventRegs.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-500">No participants registered yet.</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Order Details Modal
        const OrderModal = ({ order, isOpen, onClose, onUpdateStatus }) => {
            if (!isOpen || !order) return null;

            const total = order.total || 0;
            const statuses = ['pending', 'processing', 'shipped', 'delivered', 'cancelled'];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto no-scrollbar p-6 shadow-2xl relative animate-in zoom-in-95 duration-200">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-700 bg-slate-50 rounded-full p-1"><X size={20}/></button>
                        
                        <div className="flex flex-col sm:flex-row justify-between items-start mb-6 border-b pb-4 gap-4 pr-8">
                            <div>
                                <h2 className="text-xl font-bold text-slate-900 break-all">Order #{order.id.slice(0,8).toUpperCase()}</h2>
                                <p className="text-sm text-slate-500">{new Date(order.createdAt?.seconds * 1000).toLocaleString()}</p>
                            </div>
                            <div className="text-left sm:text-right">
                                <span className={`inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider
                                    ${order.status === 'delivered' ? 'bg-green-100 text-green-700' : 
                                      order.status === 'shipped' ? 'bg-purple-100 text-purple-700' : 
                                      order.status === 'processing' ? 'bg-blue-100 text-blue-700' : 
                                      order.status === 'cancelled' ? 'bg-red-100 text-red-700' : 
                                      'bg-yellow-100 text-yellow-700'}`}>
                                    {order.status}
                                </span>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6 mb-8">
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <h3 className="text-sm font-bold text-slate-800 mb-2 flex items-center gap-2"><Users size={16}/> Customer Details</h3>
                                <p className="text-sm font-medium">{order.userName}</p>
                                <p className="text-sm text-slate-600">{order.contact || 'No phone provided'}</p>
                                <p className="text-sm text-slate-600 mt-2 whitespace-pre-wrap">{order.address || 'No address provided'}</p>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <h3 className="text-sm font-bold text-slate-800 mb-2 flex items-center gap-2"><Settings size={16}/> Management Action</h3>
                                <label className="block text-xs text-slate-500 mb-1">Update Status:</label>
                                <select 
                                    className="w-full border border-slate-200 rounded-lg p-2 text-sm outline-none bg-white focus:ring-2 focus:ring-emerald-500"
                                    value={order.status}
                                    onChange={(e) => onUpdateStatus(order.id, e.target.value)}
                                >
                                    {statuses.map(s => <option key={s} value={s}>{s.charAt(0).toUpperCase() + s.slice(1)}</option>)}
                                </select>
                                <div className="mt-4 pt-4 border-t border-slate-200">
                                    <p className="text-xs text-slate-500">Payment Method</p>
                                    <p className="text-sm font-bold uppercase">{order.method || 'Unknown'}</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 className="font-bold text-slate-800 mb-3 border-b pb-2">Order Items</h3>
                            <div className="space-y-3 mb-6">
                                {(order.items || []).map((item, idx) => (
                                    <div key={idx} className="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-slate-50 p-3 rounded-lg border border-slate-100 gap-3">
                                        <div className="flex items-center gap-3">
                                            <img src={item.image} alt={item.name} className="w-12 h-12 object-cover rounded bg-white border shrink-0"/>
                                            <div>
                                                <p className="text-sm font-bold line-clamp-1">{item.name}</p>
                                                <p className="text-xs text-slate-500">₦{item.price?.toLocaleString()} x {item.qty}</p>
                                            </div>
                                        </div>
                                        <div className="font-bold text-sm sm:self-center self-end">
                                            ₦{(item.price * item.qty).toLocaleString()}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="flex justify-between items-center text-lg sm:text-xl font-bold bg-emerald-50 text-emerald-900 p-4 rounded-xl border border-emerald-100">
                                <span>Total Amount:</span>
                                <span>₦{total.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Main App
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('dashboard');
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            
            // Core Data
            const [products, setProducts] = useState([]);
            const [orders, setOrders] = useState([]);
            const [recs, setRecs] = useState([]);
            const [events, setEvents] = useState([]);
            const [registrations, setRegistrations] = useState([]);
            const [posts, setPosts] = useState([]);
            
            // Modal States
            const [isProductModalOpen, setProductModalOpen] = useState(false);
            const [isEventModalOpen, setEventModalOpen] = useState(false);
            const [isPostModalOpen, setPostModalOpen] = useState(false);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [selectedEventForRegs, setSelectedEventForRegs] = useState(null);

            // Login State
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loginError, setLoginError] = useState('');

            useEffect(() => {
                const unsubAuth = onAuthStateChanged(auth, (u) => {
                    if (u && ADMIN_EMAILS.includes(u.email)) {
                        setUser(u);
                    } else {
                        setUser(null);
                        if (u) signOut(auth); // Sign out unauthorized users
                    }
                    setLoading(false);
                });
                return () => unsubAuth();
            }, []);

            useEffect(() => {
                if (!user) return;
                
                const qP = collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_products');
                const qO = collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_orders');
                const qR = collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_recommendations');
                const qE = collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_events');
                const qReg = collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_event_registrations');
                const qPosts = collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_updates');
                
                const uP = onSnapshot(qP, s => {
                    setProducts(s.docs.map(d=>({id:d.id,...d.data()})));
                });
                const uO = onSnapshot(qO, s => {
                    const data = s.docs.map(d=>({id:d.id,...d.data()}));
                    data.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setOrders(data);
                });
                const uR = onSnapshot(qR, s => setRecs(s.docs.map(d=>({id:d.id,...d.data()}))));
                
                const uE = onSnapshot(qE, s => {
                    const data = s.docs.map(d=>({id:d.id,...d.data()}));
                    data.sort((a,b) => new Date(b.date) - new Date(a.date)); // Sort newest events first
                    setEvents(data);
                });
                
                const uReg = onSnapshot(qReg, s => {
                    setRegistrations(s.docs.map(d=>({id:d.id,...d.data()})));
                });

                const uPosts = onSnapshot(qPosts, s => {
                    const data = s.docs.map(d=>({id:d.id,...d.data()}));
                    data.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setPosts(data);
                });
                
                return () => { uP(); uO(); uR(); uE(); uReg(); uPosts(); };
            }, [user]);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoginError('');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setLoginError("Invalid admin credentials.");
                }
            };

            // Store Functions
            const handleAddProduct = async (productData) => {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_products'), productData);
                    setProductModalOpen(false);
                } catch (e) { alert("Error adding product"); }
            };

            const handleDeleteProduct = async (id) => {
                if(confirm("Are you sure you want to delete this product?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_products', id));
                }
            };

            const updateStock = async (id, newStock) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_products', id), { stock: Number(newStock) });
            };

            const toggleFeatured = async (id, currentStatus) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_products', id), { featured: !currentStatus });
                } catch (e) { alert("Failed to update featured status."); }
            };

            const updateOrderStatus = async (orderId, newStatus) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_orders', orderId), { status: newStatus });
                    setSelectedOrder(prev => prev ? {...prev, status: newStatus} : null);
                } catch (e) { alert("Failed to update status."); }
            };

            // Events Functions
            const handleAddEvent = async (eventData) => {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_events'), {
                        ...eventData,
                        createdAt: serverTimestamp()
                    });
                    setEventModalOpen(false);
                } catch (e) { alert("Error adding event"); }
            };

            const handleDeleteEvent = async (id) => {
                if(confirm("Are you sure you want to delete this event? Existing registrations will be orphaned.")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_events', id));
                }
            };

            const updateEventStatus = async (eventId, newStatus) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_events', eventId), { status: newStatus });
                } catch (e) { alert("Failed to update event status."); }
            };

            // Content Functions
            const handleAddPost = async (postData) => {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_updates'), {
                        ...postData,
                        createdAt: serverTimestamp()
                    });
                    setPostModalOpen(false);
                } catch (e) { alert("Error adding post"); }
            };

            const handleDeletePost = async (id) => {
                if(confirm("Are you sure you want to delete this update? It will be permanently removed from the Info page.")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_updates', id));
                }
            };

            const togglePostPublish = async (id, currentStatus) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_updates', id), { published: !currentStatus });
                } catch (e) { alert("Failed to update post status."); }
            };

            // Calculated Stats
            const stats = useMemo(() => {
                const totalRevenue = orders.filter(o => o.status === 'delivered').reduce((sum, o) => sum + (o.total || 0), 0);
                const pendingOrders = orders.filter(o => o.status === 'pending').length;
                const lowStockItems = products.filter(p => p.type !== 'service' && p.stock < 5).length;
                const activeEvents = events.filter(e => e.status !== 'completed').length;
                const publishedPosts = posts.filter(p => p.published).length;
                return { totalRevenue, pendingOrders, lowStockItems, totalProducts: products.length, activeEvents, publishedPosts };
            }, [orders, products, events, posts]);

            const handleNavClick = (newView) => {
                setView(newView);
                setMobileMenuOpen(false);
            }

            if (loading) return <div className="min-h-screen flex items-center justify-center"><Loader2 size={40} className="animate-spin text-emerald-600"/></div>;

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 p-4">
                        <div className="bg-white p-8 rounded-[2rem] w-full max-w-sm shadow-2xl">
                            <div className="text-center mb-8">
                                <img src="logo.png" alt="Mbtech Logo" className="h-12 w-auto mx-auto mb-4 object-contain" onError={(e)=>{e.target.onerror=null; e.target.src='https://placehold.co/100x40/059669/ffffff?text=MBTech'}}/>
                                <h1 className="text-2xl font-black text-slate-900">Admin Portal</h1>
                                <p className="text-sm font-bold text-slate-500 uppercase tracking-widest mt-1">Official Management</p>
                            </div>
                            <form onSubmit={handleLogin} className="space-y-4">
                                {loginError && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-xl border border-red-100 font-medium">{loginError}</div>}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Admin Email</label>
                                    <input type="email" value={email} onChange={e=>setEmail(e.target.value)} required className="w-full p-3.5 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 bg-slate-50 transition-shadow"/>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Password</label>
                                    <input type="password" value={password} onChange={e=>setPassword(e.target.value)} required className="w-full p-3.5 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 bg-slate-50 transition-shadow"/>
                                </div>
                                <button type="submit" className="w-full py-4 bg-slate-900 text-white font-bold rounded-xl shadow-lg hover:bg-emerald-600 transition-colors mt-6 flex items-center justify-center gap-2">
                                    <Lock size={18}/> Access Portal
                                </button>
                            </form>
                            <div className="mt-6 text-center border-t border-slate-100 pt-6">
                                <a href="store.html" className="text-sm font-bold text-emerald-600 hover:text-emerald-700 transition-colors flex items-center justify-center gap-1">
                                    <Home size={14}/> Back to Platform
                                </a>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen bg-slate-50 overflow-hidden relative">
                    {/* Mobile Navigation Bar (Bottom) */}
                    <div className="md:hidden fixed bottom-0 w-full bg-slate-900 border-t border-slate-800 z-40 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.1)]">
                        <div className="flex justify-around items-center h-16 px-2">
                            <button onClick={() => handleNavClick('dashboard')} className={`flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors ${view === 'dashboard' ? 'text-emerald-400' : 'text-slate-400 hover:text-emerald-400'}`}>
                                <TrendingUp size={20} />
                                <span className="text-[9px] font-bold uppercase tracking-wider">Dash</span>
                            </button>
                            <button onClick={() => handleNavClick('products')} className={`flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors ${view === 'products' ? 'text-emerald-400' : 'text-slate-400 hover:text-emerald-400'}`}>
                                <Package size={20} />
                                <span className="text-[9px] font-bold uppercase tracking-wider">Store</span>
                            </button>
                            <button onClick={() => handleNavClick('events')} className={`flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors ${view === 'events' ? 'text-emerald-400' : 'text-slate-400 hover:text-emerald-400'}`}>
                                <Calendar size={20} />
                                <span className="text-[9px] font-bold uppercase tracking-wider">Events</span>
                            </button>
                            <button onClick={() => handleNavClick('posts')} className={`flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors ${view === 'posts' ? 'text-emerald-400' : 'text-slate-400 hover:text-emerald-400'}`}>
                                <Newspaper size={20} />
                                <span className="text-[9px] font-bold uppercase tracking-wider">News</span>
                            </button>
                            <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className={`flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors ${mobileMenuOpen ? 'text-emerald-400' : 'text-slate-400 hover:text-emerald-400'}`}>
                                <Menu size={20} />
                                <span className="text-[9px] font-bold uppercase tracking-wider">More</span>
                            </button>
                        </div>
                    </div>

                    {/* Mobile More Menu Overlay */}
                    {mobileMenuOpen && (
                        <div className="md:hidden fixed inset-0 z-30 bg-black/60 backdrop-blur-sm flex items-end justify-center" onClick={() => setMobileMenuOpen(false)}>
                            <div className="bg-slate-900 w-full rounded-t-[2rem] p-6 pb-24 space-y-4 shadow-2xl animate-in slide-in-from-bottom border-t border-slate-800" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center border-b border-slate-800 pb-4 mb-2 text-white">
                                    <h3 className="font-bold">More Options</h3>
                                    <button onClick={() => setMobileMenuOpen(false)} className="p-1 hover:bg-slate-800 rounded-full"><X size={24}/></button>
                                </div>
                                <button onClick={()=>handleNavClick('orders')} className={`w-full flex items-center justify-between px-4 py-3.5 rounded-xl transition-colors ${view==='orders'?'bg-emerald-600 text-white':'text-slate-300 hover:bg-slate-800 border border-slate-800'}`}>
                                    <span className="flex items-center gap-3 font-bold"><ShoppingCart size={18}/> Manage Orders</span>
                                    {stats.pendingOrders > 0 && <span className="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">{stats.pendingOrders} New</span>}
                                </button>
                                <button onClick={()=>handleNavClick('requests')} className={`w-full flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-colors ${view==='requests'?'bg-emerald-600 text-white':'text-slate-300 hover:bg-slate-800 border border-slate-800'}`}>
                                    <Users size={18}/> Customer Requests
                                </button>
                                <div className="border-t border-slate-800 pt-4 mt-2">
                                    <div className="text-xs mb-3 text-slate-500 px-2 font-medium">Logged in as: <br/><span className="text-white truncate block mt-1 font-bold">{user.email}</span></div>
                                    <button onClick={()=>signOut(auth)} className="w-full flex items-center justify-center gap-2 px-4 py-3.5 bg-slate-800 hover:bg-red-500 font-bold text-slate-300 hover:text-white rounded-xl transition-colors"><LogOut size={18}/> Secure Sign Out</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Sidebar (Desktop) */}
                    <aside className="w-64 bg-slate-900 text-slate-300 flex-col hidden md:flex shrink-0">
                        <div className="p-6 border-b border-slate-800">
                            <h2 className="text-xl font-black text-white flex items-center gap-2">
                                <div className="p-1.5 bg-emerald-500 rounded-lg text-white shadow-lg shadow-emerald-500/20"><LayoutDashboard size={20}/></div>
                                Mbtech Admin
                            </h2>
                        </div>
                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto no-scrollbar">
                            <p className="text-[10px] font-black uppercase tracking-widest text-slate-500 mb-3 mt-4 ml-2">Store Management</p>
                            <button onClick={()=>setView('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition-all ${view==='dashboard'?'bg-emerald-600 text-white shadow-md shadow-emerald-500/20':'hover:bg-slate-800 text-slate-400 hover:text-white'}`}><TrendingUp size={18}/> Dashboard</button>
                            <button onClick={()=>setView('products')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition-all ${view==='products'?'bg-emerald-600 text-white shadow-md shadow-emerald-500/20':'hover:bg-slate-800 text-slate-400 hover:text-white'}`}><Package size={18}/> Products & Stock</button>
                            <button onClick={()=>setView('orders')} className={`w-full flex items-center justify-between px-4 py-3 rounded-xl font-bold transition-all ${view==='orders'?'bg-emerald-600 text-white shadow-md shadow-emerald-500/20':'hover:bg-slate-800 text-slate-400 hover:text-white'}`}>
                                <span className="flex items-center gap-3"><ShoppingCart size={18}/> Orders</span>
                                {stats.pendingOrders > 0 && <span className="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full">{stats.pendingOrders}</span>}
                            </button>
                            <button onClick={()=>setView('requests')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition-all ${view==='requests'?'bg-emerald-600 text-white shadow-md shadow-emerald-500/20':'hover:bg-slate-800 text-slate-400 hover:text-white'}`}><Users size={18}/> Product Requests</button>
                            
                            <p className="text-[10px] font-black uppercase tracking-widest text-slate-500 mb-3 mt-8 ml-2">Academy & Events</p>
                            <button onClick={()=>setView('events')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition-all ${view==='events'?'bg-emerald-600 text-white shadow-md shadow-emerald-500/20':'hover:bg-slate-800 text-slate-400 hover:text-white'}`}><Calendar size={18}/> Events & Classes</button>

                            <p className="text-[10px] font-black uppercase tracking-widest text-slate-500 mb-3 mt-8 ml-2">Content & Media</p>
                            <button onClick={()=>setView('posts')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition-all ${view==='posts'?'bg-emerald-600 text-white shadow-md shadow-emerald-500/20':'hover:bg-slate-800 text-slate-400 hover:text-white'}`}><Newspaper size={18}/> News & Updates</button>
                        </nav>
                        <div className="p-4 border-t border-slate-800 bg-slate-900/50 backdrop-blur">
                            <div className="text-xs mb-3 text-slate-500 font-medium">Logged in as: <br/><span className="text-white truncate block mt-0.5 font-bold">{user.email}</span></div>
                            <button onClick={()=>signOut(auth)} className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-slate-800 hover:bg-red-500 hover:text-white font-bold rounded-xl transition-colors"><LogOut size={16}/> Sign Out</button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col h-screen overflow-y-auto no-scrollbar bg-[#f8fafc]">
                        <header className="bg-white border-b border-slate-200 px-4 md:px-8 py-4 flex justify-between items-center sticky top-0 z-20 shadow-sm">
                            <h1 className="text-xl md:text-2xl font-black text-slate-800 capitalize truncate pr-2 tracking-tight">{view === 'dashboard' ? 'Platform Overview' : view}</h1>
                            <div className="flex gap-4 shrink-0">
                                <a href="store.html" target="_blank" className="text-sm font-bold text-emerald-600 hover:text-emerald-700 bg-emerald-50 px-3 py-1.5 rounded-full flex items-center gap-1.5 transition-colors border border-emerald-100">Live Store <Eye size={14}/></a>
                            </div>
                        </header>

                        <div className="p-4 md:p-8">
                            {/* DASHBOARD VIEW */}
                            {view === 'dashboard' && (
                                <div className="space-y-8 animate-in fade-in duration-300">
                                    <h3 className="font-black text-lg text-slate-800 border-b border-slate-200 pb-2 uppercase tracking-wide text-xs">Store Performance</h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                                        <div className="bg-white p-5 md:p-6 rounded-[1.5rem] shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition-shadow">
                                            <div className="p-3 md:p-4 bg-emerald-50 text-emerald-600 rounded-2xl"><DollarSign size={24}/></div>
                                            <div>
                                                <p className="text-xs md:text-sm text-slate-500 font-bold uppercase tracking-wider">Delivered Revenue</p>
                                                <p className="text-xl md:text-2xl font-black text-slate-900 mt-0.5">₦{stats.totalRevenue.toLocaleString()}</p>
                                            </div>
                                        </div>
                                        <div className="bg-white p-5 md:p-6 rounded-[1.5rem] shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition-shadow">
                                            <div className="p-3 md:p-4 bg-yellow-50 text-yellow-600 rounded-2xl"><Clock size={24}/></div>
                                            <div>
                                                <p className="text-xs md:text-sm text-slate-500 font-bold uppercase tracking-wider">Pending Orders</p>
                                                <p className="text-xl md:text-2xl font-black text-slate-900 mt-0.5">{stats.pendingOrders}</p>
                                            </div>
                                        </div>
                                        <div className="bg-white p-5 md:p-6 rounded-[1.5rem] shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition-shadow">
                                            <div className="p-3 md:p-4 bg-red-50 text-red-600 rounded-2xl"><AlertTriangle size={24}/></div>
                                            <div>
                                                <p className="text-xs md:text-sm text-slate-500 font-bold uppercase tracking-wider">Low Stock Items</p>
                                                <p className="text-xl md:text-2xl font-black text-slate-900 mt-0.5">{stats.lowStockItems}</p>
                                            </div>
                                        </div>
                                        <div className="bg-white p-5 md:p-6 rounded-[1.5rem] shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition-shadow">
                                            <div className="p-3 md:p-4 bg-blue-50 text-blue-600 rounded-2xl"><Archive size={24}/></div>
                                            <div>
                                                <p className="text-xs md:text-sm text-slate-500 font-bold uppercase tracking-wider">Total Catalog</p>
                                                <p className="text-xl md:text-2xl font-black text-slate-900 mt-0.5">{stats.totalProducts}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <h3 className="font-black text-lg text-slate-800 border-b border-slate-200 pb-2 pt-4 uppercase tracking-wide text-xs">Events & Content</h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                                        <div className="bg-white p-5 md:p-6 rounded-[1.5rem] shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition-shadow">
                                            <div className="p-3 md:p-4 bg-purple-50 text-purple-600 rounded-2xl"><Calendar size={24}/></div>
                                            <div>
                                                <p className="text-xs md:text-sm text-slate-500 font-bold uppercase tracking-wider">Active Events</p>
                                                <p className="text-xl md:text-2xl font-black text-slate-900 mt-0.5">{stats.activeEvents}</p>
                                            </div>
                                        </div>
                                        <div className="bg-white p-5 md:p-6 rounded-[1.5rem] shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition-shadow">
                                            <div className="p-3 md:p-4 bg-indigo-50 text-indigo-600 rounded-2xl"><Users size={24}/></div>
                                            <div>
                                                <p className="text-xs md:text-sm text-slate-500 font-bold uppercase tracking-wider">Registrations</p>
                                                <p className="text-xl md:text-2xl font-black text-slate-900 mt-0.5">{registrations.length}</p>
                                            </div>
                                        </div>
                                        <div className="bg-white p-5 md:p-6 rounded-[1.5rem] shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition-shadow">
                                            <div className="p-3 md:p-4 bg-orange-50 text-orange-600 rounded-2xl"><Newspaper size={24}/></div>
                                            <div>
                                                <p className="text-xs md:text-sm text-slate-500 font-bold uppercase tracking-wider">Published Articles</p>
                                                <p className="text-xl md:text-2xl font-black text-slate-900 mt-0.5">{stats.publishedPosts}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8 pt-4">
                                        <div className="bg-white p-5 md:p-6 rounded-[2rem] shadow-sm border border-slate-100">
                                            <h3 className="font-black text-lg mb-4 flex items-center gap-2"><Clock className="text-slate-400"/> Recent Store Orders</h3>
                                            <div className="space-y-3">
                                                {orders.slice(0, 5).map(o => (
                                                    <div key={o.id} className="flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100 rounded-xl cursor-pointer border border-transparent hover:border-slate-200 transition-colors" onClick={() => { setSelectedOrder(o); setView('orders'); }}>
                                                        <div>
                                                            <p className="font-bold text-sm line-clamp-1">{o.userName}</p>
                                                            <p className="text-xs font-medium text-slate-500 mt-0.5">#{o.id.slice(0,6).toUpperCase()} • {new Date(o.createdAt?.seconds*1000).toLocaleDateString()}</p>
                                                        </div>
                                                        <div className="text-right shrink-0">
                                                            <p className="font-black text-sm">₦{o.total?.toLocaleString()}</p>
                                                            <span className="text-[10px] px-2.5 py-1 rounded-full bg-white uppercase font-bold text-slate-600 shadow-sm border border-slate-100 inline-block mt-1">{o.status}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                                {orders.length === 0 && <p className="text-sm font-medium text-slate-500 text-center py-6 bg-slate-50 rounded-xl border border-dashed border-slate-200">No recent orders found.</p>}
                                            </div>
                                        </div>
                                        
                                        <div className="bg-white p-5 md:p-6 rounded-[2rem] shadow-sm border border-slate-100">
                                            <h3 className="font-black text-lg mb-4 flex items-center gap-2 text-red-600"><AlertTriangle /> Low Stock Alerts</h3>
                                            <div className="space-y-3">
                                                {products.filter(p => p.type !== 'service' && p.stock < 5).map(p => (
                                                    <div key={p.id} className="flex flex-col sm:flex-row sm:justify-between sm:items-center p-4 bg-red-50/50 rounded-xl border border-red-100 gap-3">
                                                        <div className="flex items-center gap-3">
                                                            <img src={p.image} className="w-12 h-12 rounded-lg bg-white object-cover border border-red-100 shrink-0"/>
                                                            <div>
                                                                <p className="font-bold text-sm text-slate-900 line-clamp-1">{p.name}</p>
                                                                <p className="text-xs font-medium text-slate-500">{p.category}</p>
                                                            </div>
                                                        </div>
                                                        <div className="sm:text-right self-start sm:self-auto">
                                                            <span className="text-xs font-black px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-center inline-block">Stock: {p.stock || 0}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                                {stats.lowStockItems === 0 && <p className="text-sm font-medium text-slate-500 text-center py-6 bg-emerald-50 text-emerald-700 rounded-xl border border-dashed border-emerald-200">All stock levels are perfectly healthy!</p>}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* PRODUCTS VIEW */}
                            {view === 'products' && (
                                <div className="animate-in fade-in duration-300">
                                    <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-4">
                                        <h2 className="text-lg font-bold text-slate-500">Manage Inventory & Catalog</h2>
                                        <button onClick={() => setProductModalOpen(true)} className="flex items-center justify-center gap-2 bg-emerald-600 text-white px-5 py-2.5 rounded-xl hover:bg-emerald-700 font-bold shadow-md shadow-emerald-500/20 transition-all active:scale-95 w-full sm:w-auto"><Plus size={18}/> Add Product</button>
                                    </div>
                                    <div className="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-x-auto">
                                        <table className="w-full text-left text-sm whitespace-nowrap">
                                            <thead className="bg-slate-50 text-slate-600 border-b border-slate-200">
                                                <tr>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs">Product</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs hidden sm:table-cell">Category</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs">Price</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs">Stock</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs text-right">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {products.map(p => (
                                                    <tr key={p.id} className="hover:bg-slate-50 transition-colors">
                                                        <td className="p-4 flex items-center gap-3">
                                                            <img src={p.image} className="w-10 h-10 md:w-12 md:h-12 rounded-xl object-cover bg-white border border-slate-200 shrink-0"/>
                                                            <div className="flex flex-col">
                                                                <span className="font-bold text-slate-900 truncate max-w-[150px] md:max-w-xs">{p.name}</span>
                                                                <span className="text-[10px] font-bold text-slate-400 sm:hidden mt-0.5 uppercase tracking-wider">{p.category}</span>
                                                            </div>
                                                        </td>
                                                        <td className="p-4 hidden sm:table-cell">
                                                            <span className="block font-bold text-slate-700">{p.category}</span>
                                                            <span className="text-[9px] font-black uppercase tracking-widest text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded inline-block mt-1">{p.type}</span>
                                                        </td>
                                                        <td className="p-4 font-black text-slate-800">₦{p.price?.toLocaleString()}</td>
                                                        <td className="p-4">
                                                            {p.type === 'service' ? (
                                                                <span className="text-slate-400 font-bold text-xs bg-slate-100 px-2 py-1 rounded">N/A</span>
                                                            ) : (
                                                                <div className="flex items-center gap-2">
                                                                    <input type="number" className="w-16 p-2 bg-white border border-slate-200 rounded-lg text-center text-sm font-bold focus:ring-2 focus:ring-emerald-500 outline-none" value={p.stock || 0} onChange={(e) => updateStock(p.id, e.target.value)} />
                                                                    {p.stock < 5 && <AlertTriangle size={16} className="text-red-500 shrink-0"/>}
                                                                </div>
                                                            )}
                                                        </td>
                                                        <td className="p-4 flex justify-end gap-1">
                                                            <button onClick={() => toggleFeatured(p.id, p.featured)} className={`p-2 rounded-xl transition-colors ${p.featured ? 'text-yellow-500 bg-yellow-50 hover:bg-yellow-100' : 'text-slate-400 bg-slate-100 hover:text-yellow-500 hover:bg-yellow-50'}`} title={p.featured ? "Remove from Featured" : "Mark as Featured"}>
                                                                <Star size={18} fill={p.featured ? "currentColor" : "none"} />
                                                            </button>
                                                            <button onClick={() => handleDeleteProduct(p.id)} className="p-2 text-red-500 bg-red-50 hover:bg-red-500 hover:text-white rounded-xl transition-colors"><Trash2 size={18}/></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {products.length === 0 && <tr><td colSpan="5" className="p-12 text-center font-medium text-slate-500">No products found. Click "Add Product" to start building your catalog.</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                    <ProductModal isOpen={isProductModalOpen} onClose={() => setProductModalOpen(false)} onSave={handleAddProduct} />
                                </div>
                            )}

                            {/* ORDERS VIEW */}
                            {view === 'orders' && (
                                <div className="animate-in fade-in duration-300">
                                    <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-4">
                                        <h2 className="text-lg font-bold text-slate-500">Manage Customer Orders</h2>
                                    </div>
                                    <div className="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-x-auto">
                                        <table className="w-full text-left text-sm whitespace-nowrap">
                                            <thead className="bg-slate-50 text-slate-600 border-b border-slate-200">
                                                <tr>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs">Order ID</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs">Customer</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs hidden md:table-cell">Date</th>
                                                    <th className="p-4 font-bold uppercase tracking-wider text-xs">Total</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs">Status</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs text-right">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {orders.map(o => (
                                                    <tr key={o.id} className="hover:bg-slate-50 transition-colors">
                                                        <td className="p-4 font-mono font-bold text-xs text-slate-500">#{o.id.slice(0,8).toUpperCase()}</td>
                                                        <td className="p-4">
                                                            <span className="font-bold text-slate-900 block">{o.userName}</span>
                                                            <span className="text-[10px] font-bold text-slate-400 md:hidden mt-0.5 block">{new Date(o.createdAt?.seconds*1000).toLocaleDateString()}</span>
                                                        </td>
                                                        <td className="p-4 font-medium text-slate-500 hidden md:table-cell">{new Date(o.createdAt?.seconds*1000).toLocaleDateString()}</td>
                                                        <td className="p-4 font-black text-slate-800">₦{o.total?.toLocaleString()}</td>
                                                        <td className="p-4">
                                                            <select 
                                                                className={`border rounded-lg px-3 py-1.5 text-[10px] sm:text-xs font-black uppercase tracking-wider outline-none cursor-pointer
                                                                    ${o.status === 'delivered' ? 'bg-green-50 text-green-700 border-green-200' : 
                                                                    o.status === 'shipped' ? 'bg-purple-50 text-purple-700 border-purple-200' : 
                                                                    o.status === 'processing' ? 'bg-blue-50 text-blue-700 border-blue-200' : 
                                                                    o.status === 'cancelled' ? 'bg-red-50 text-red-700 border-red-200' : 
                                                                    'bg-yellow-50 text-yellow-700 border-yellow-200'}`}
                                                                value={o.status}
                                                                onChange={(e) => updateOrderStatus(o.id, e.target.value)}
                                                            >
                                                                <option value="pending">Pending</option>
                                                                <option value="processing">Processing</option>
                                                                <option value="shipped">Shipped</option>
                                                                <option value="delivered">Delivered</option>
                                                                <option value="cancelled">Cancelled</option>
                                                            </select>
                                                        </td>
                                                        <td className="p-4 text-right">
                                                            <button onClick={() => setSelectedOrder(o)} className="px-4 py-2 bg-slate-900 hover:bg-slate-800 text-white font-bold rounded-lg text-xs transition-colors shadow-md">Review</button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {orders.length === 0 && <tr><td colSpan="6" className="p-12 text-center font-medium text-slate-500">No orders received yet.</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                    <OrderModal order={selectedOrder} isOpen={!!selectedOrder} onClose={() => setSelectedOrder(null)} onUpdateStatus={updateOrderStatus} />
                                </div>
                            )}

                            {/* REQUESTS VIEW */}
                            {view === 'requests' && (
                                <div className="animate-in fade-in duration-300">
                                    <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-4">
                                        <h2 className="text-lg font-bold text-slate-500">Customer Sourcing Requests</h2>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                                        {recs.map(r => (
                                            <div key={r.id} className="bg-white p-5 md:p-6 rounded-[2rem] shadow-sm border border-slate-100 flex flex-col h-full hover:shadow-md transition-shadow">
                                                <div className="flex items-start gap-4 mb-4">
                                                    <div className="w-12 h-12 rounded-2xl bg-emerald-50 flex items-center justify-center text-emerald-600 font-black text-xl uppercase shrink-0 border border-emerald-100">
                                                        {r.userName?.charAt(0) || 'U'}
                                                    </div>
                                                    <div className="overflow-hidden pt-1">
                                                        <p className="font-black text-slate-900 truncate">{r.userName || 'Anonymous User'}</p>
                                                        <p className="text-[10px] font-bold uppercase tracking-wider text-slate-400 mt-0.5">{new Date(r.createdAt?.seconds*1000).toLocaleString()}</p>
                                                    </div>
                                                </div>
                                                <div className="bg-slate-50 p-4 rounded-2xl flex-1 border border-slate-100 mb-4">
                                                    <p className="text-sm font-medium text-slate-700 leading-relaxed italic">"{r.description}"</p>
                                                </div>
                                                <div className="pt-4 border-t border-slate-100 flex justify-between items-center">
                                                    <span className="text-xs font-bold text-slate-500">{r.contact || 'No Contact'}</span>
                                                    <button onClick={async () => {
                                                        if(confirm('Delete this request?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_recommendations', r.id));
                                                    }} className="text-[10px] font-black uppercase tracking-wider text-red-500 hover:text-white bg-red-50 hover:bg-red-500 px-3 py-1.5 rounded-lg transition-colors">Dismiss</button>
                                                </div>
                                            </div>
                                        ))}
                                        {recs.length === 0 && <div className="col-span-full p-16 text-center font-medium text-slate-500 bg-white rounded-[2rem] border border-dashed border-slate-200">No sourcing requests currently.</div>}
                                    </div>
                                </div>
                            )}
                            
                            {/* EVENTS VIEW */}
                            {view === 'events' && (
                                <div className="animate-in fade-in duration-300">
                                    <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-4">
                                        <h2 className="text-lg font-bold text-slate-500">Manage Hosted Events & Classes</h2>
                                        <button onClick={() => setEventModalOpen(true)} className="flex items-center justify-center gap-2 bg-emerald-600 text-white px-5 py-2.5 rounded-xl hover:bg-emerald-700 font-bold shadow-md shadow-emerald-500/20 transition-all active:scale-95 w-full sm:w-auto"><Plus size={18}/> Add Event</button>
                                    </div>
                                    <div className="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-x-auto">
                                        <table className="w-full text-left text-sm whitespace-nowrap">
                                            <thead className="bg-slate-50 text-slate-600 border-b border-slate-200">
                                                <tr>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs">Event Details</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs hidden sm:table-cell">Schedule</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs hidden lg:table-cell">Location</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs">Status</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs text-right">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {events.map(e => (
                                                    <tr key={e.id} className="hover:bg-slate-50 transition-colors">
                                                        <td className="p-4 flex items-center gap-4">
                                                            <img src={e.image} className="w-12 h-12 md:w-14 md:h-14 rounded-xl object-cover bg-white border border-slate-200 shrink-0" onError={(ev)=>{ev.target.src='https://placehold.co/100?text=Event'}}/>
                                                            <div className="flex flex-col">
                                                                <span className="font-bold text-slate-900 truncate max-w-[150px] sm:max-w-[250px]">{e.title}</span>
                                                                <span className="text-[10px] font-bold text-slate-400 sm:hidden mt-0.5 uppercase tracking-wider">{e.date}</span>
                                                            </div>
                                                        </td>
                                                        <td className="p-4 hidden sm:table-cell">
                                                            <div className="flex items-center gap-2 font-medium text-slate-700"><Calendar size={14} className="text-slate-400 shrink-0"/> {e.date}</div>
                                                            <div className="flex items-center gap-2 mt-1.5 text-xs font-medium text-slate-500"><Clock size={14} className="text-slate-400 shrink-0"/> {e.time}</div>
                                                        </td>
                                                        <td className="p-4 hidden lg:table-cell">
                                                            <div className="flex items-center gap-2 font-medium text-slate-700"><MapPin size={14} className="text-slate-400 shrink-0"/> <span className="truncate max-w-[150px]">{e.location}</span></div>
                                                        </td>
                                                        <td className="p-4">
                                                            <select 
                                                                className={`border rounded-lg px-3 py-1.5 text-[10px] sm:text-xs font-black uppercase tracking-wider outline-none cursor-pointer
                                                                    ${e.status === 'completed' ? 'bg-slate-100 text-slate-500 border-slate-200' : 
                                                                    e.status === 'ongoing' ? 'bg-blue-50 text-blue-700 border-blue-200' : 
                                                                    'bg-emerald-50 text-emerald-700 border-emerald-200'}`}
                                                                value={e.status || 'upcoming'}
                                                                onChange={(ev) => updateEventStatus(e.id, ev.target.value)}
                                                            >
                                                                <option value="upcoming">Upcoming</option>
                                                                <option value="ongoing">Ongoing</option>
                                                                <option value="completed">Completed</option>
                                                            </select>
                                                        </td>
                                                        <td className="p-4">
                                                            <div className="flex justify-end gap-2">
                                                                <button onClick={() => setSelectedEventForRegs(e)} className="flex items-center gap-1.5 px-4 py-2 bg-slate-900 hover:bg-slate-800 text-white font-bold rounded-lg text-xs transition-colors shadow-md">
                                                                    <ListChecks size={14} className="shrink-0"/> <span className="hidden sm:inline">View Regs</span>
                                                                </button>
                                                                <button onClick={() => handleDeleteEvent(e.id)} className="p-2 text-red-500 bg-red-50 hover:bg-red-500 hover:text-white rounded-lg transition-colors"><Trash2 size={16}/></button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {events.length === 0 && <tr><td colSpan="5" className="p-12 text-center font-medium text-slate-500">No events found. Click "Add Event" to create one.</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                    <EventModal isOpen={isEventModalOpen} onClose={() => setEventModalOpen(false)} onSave={handleAddEvent} />
                                    <RegistrationsModal event={selectedEventForRegs} registrations={registrations} isOpen={!!selectedEventForRegs} onClose={() => setSelectedEventForRegs(null)} />
                                </div>
                            )}

                            {/* POSTS/UPDATES VIEW */}
                            {view === 'posts' && (
                                <div className="animate-in fade-in duration-300">
                                    <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-4">
                                        <h2 className="text-lg font-bold text-slate-500">Manage News & Updates</h2>
                                        <button onClick={() => setPostModalOpen(true)} className="flex items-center justify-center gap-2 bg-emerald-600 text-white px-5 py-2.5 rounded-xl hover:bg-emerald-700 font-bold shadow-md shadow-emerald-500/20 transition-all active:scale-95 w-full sm:w-auto"><Plus size={18}/> New Update</button>
                                    </div>
                                    <div className="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-x-auto">
                                        <table className="w-full text-left text-sm whitespace-nowrap">
                                            <thead className="bg-slate-50 text-slate-600 border-b border-slate-200">
                                                <tr>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs">Post Details</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs hidden sm:table-cell">Category</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs hidden lg:table-cell">Date Published</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs">Status</th>
                                                    <th className="p-4 font-black uppercase tracking-wider text-xs text-right">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {posts.map(p => (
                                                    <tr key={p.id} className="hover:bg-slate-50 transition-colors">
                                                        <td className="p-4 flex items-center gap-4">
                                                            <img src={p.image} className="w-12 h-12 rounded-xl object-cover bg-white border border-slate-200 shrink-0" onError={(e)=>{e.target.src='https://placehold.co/100?text=Post'}}/>
                                                            <div className="flex flex-col">
                                                                <span className="font-bold text-slate-900 truncate max-w-[150px] md:max-w-xs">{p.title}</span>
                                                                <span className="text-[10px] font-bold text-slate-400 sm:hidden mt-0.5 uppercase tracking-wider">{p.category}</span>
                                                            </div>
                                                        </td>
                                                        <td className="p-4 hidden sm:table-cell">
                                                            <span className="bg-slate-100 px-2.5 py-1 rounded-md text-[10px] font-black uppercase tracking-widest text-slate-600">{p.category}</span>
                                                        </td>
                                                        <td className="p-4 font-medium text-slate-500 hidden lg:table-cell">
                                                            {p.createdAt?.seconds ? new Date(p.createdAt.seconds * 1000).toLocaleDateString() : p.date || 'Unknown'}
                                                        </td>
                                                        <td className="p-4">
                                                            <span className={`inline-block px-3 py-1.5 rounded-lg text-[10px] sm:text-xs font-black uppercase tracking-wider ${p.published ? 'bg-emerald-50 text-emerald-700 border border-emerald-100' : 'bg-slate-100 text-slate-500 border border-slate-200'}`}>
                                                                {p.published ? 'Published' : 'Draft'}
                                                            </span>
                                                        </td>
                                                        <td className="p-4 text-right">
                                                            <div className="flex justify-end gap-2 items-center h-full">
                                                                <button onClick={() => togglePostPublish(p.id, p.published)} className={`p-2 rounded-xl transition-colors ${p.published ? 'bg-slate-100 text-slate-500 hover:text-orange-600 hover:bg-orange-50' : 'bg-slate-900 text-white hover:bg-emerald-600'}`} title={p.published ? "Move to Draft" : "Publish Now"}>
                                                                    {p.published ? <ToggleRight size={18}/> : <ToggleLeft size={18}/>}
                                                                </button>
                                                                <button onClick={() => handleDeletePost(p.id)} className="p-2 text-red-500 bg-red-50 hover:bg-red-500 hover:text-white rounded-xl transition-colors"><Trash2 size={18}/></button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {posts.length === 0 && <tr><td colSpan="5" className="p-12 text-center font-medium text-slate-500">No updates published. Click "New Update" to create one.</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                    <PostModal isOpen={isPostModalOpen} onClose={() => setPostModalOpen(false)} onSave={handleAddPost} />
                                </div>
                            )}

                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
