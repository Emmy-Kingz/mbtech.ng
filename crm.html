<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MBTECH CRM | Customer & Order Management</title>
    
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { 
                        brand: { 
                            blue: '#0056b3', 
                            blueHover: '#004494', 
                            orange: '#f97316',
                            dark: '#0f172a'
                        } 
                    }
                }
            }
        }
    </script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/12.10.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/12.10.0/firebase-firestore.js",
            "firebase/analytics": "https://www.gstatic.com/firebasejs/12.10.0/firebase-analytics.js"
        }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f8fafc; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-800 antialiased min-h-screen flex flex-col">
    <div id="root" class="flex-1 flex flex-col"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            LayoutDashboard, Users, ShoppingBag, Mail, Lock, LogOut, Check,
            ShieldAlert, Loader2, CreditCard, Search, Filter, Phone, MapPin,
            ExternalLink, Clock, Package, CheckCircle, XCircle, Send, ShieldCheck,
            Download, UploadCloud
        } from 'lucide-react';

        // --- FIREBASE IMPORTS ---
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'firebase/auth';
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, addDoc, serverTimestamp } from 'firebase/firestore';
        import { getAnalytics } from 'firebase/analytics';

        // Updated Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDRkEVsI2swGV5cgn_0gMHTIWUbLhsacfY",
            authDomain: "mbtechstore-17984.firebaseapp.com",
            projectId: "mbtechstore-17984",
            storageBucket: "mbtechstore-17984.firebasestorage.app",
            messagingSenderId: "1083008774596",
            appId: "1:1083008774596:web:110b651c6426116ed43491",
            measurementId: "G-213C6T6EJ0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = typeof window !== 'undefined' ? getAnalytics(app) : null;
        
        const appId = 'mbtech-public-store';

        // --- COMPONENTS ---
        function Toast({ message, type, onClose }) {
            useEffect(() => { const timer = setTimeout(onClose, 3500); return () => clearTimeout(timer); }, [onClose]);
            const bgClass = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-slate-800';
            return (
                <div className="fixed bottom-6 right-6 z-[80] animate-in slide-in-from-bottom-5">
                    <div className={bgClass + " text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 font-bold"}>
                        {type === 'success' ? <Check size={18}/> : <ShieldAlert size={18}/>}
                        {message}
                    </div>
                </div>
            );
        }

        function GlobalFooter() {
            return (
                <footer className="bg-brand-dark text-slate-400 pt-16 pb-12 border-t border-slate-800 mt-auto">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-12 border-b border-slate-800 pb-12 mb-8">
                            <div className="md:col-span-2">
                                <div className="flex items-center gap-3 mb-6">
                                    <img src="logo.png" alt="Mbtech Logo" className="h-10 w-auto object-contain" onError={(e)=>{e.target.style.display='none'}}/>
                                    <div>
                                        <h4 className="text-xl font-extrabold text-white tracking-tight uppercase">MBTECH <span className="text-brand-blue">NG</span></h4>
                                        <p className="text-xs text-brand-orange font-bold uppercase tracking-widest">Innovating Africa</p>
                                    </div>
                                </div>
                                <p className="text-sm leading-relaxed max-w-sm mb-6 text-slate-400">
                                    MBTECH NG CRM & Administrative Dashboard. This environment is secured and restricted to authorized personnel only.
                                </p>
                            </div>
                            
                            <div>
                                <h4 className="text-white font-bold mb-6 tracking-wide uppercase text-sm">Quick Links</h4>
                                <ul className="space-y-4 text-sm">
                                    <li><a href="index.html" className="hover:text-brand-orange transition-colors flex items-center gap-2">Live Website</a></li>
                                    <li><a href="admin.html" className="hover:text-brand-orange transition-colors flex items-center gap-2">Admin Workspace</a></li>
                                </ul>
                            </div>

                            <div>
                                <h4 className="text-white font-bold mb-6 tracking-wide uppercase text-sm">Contact Support</h4>
                                <ul className="space-y-4 text-sm">
                                    <li className="flex items-center gap-3"><Phone size={16} className="text-brand-blue"/> +234 708 467 2771</li>
                                    <li className="flex items-center gap-3"><Mail size={16} className="text-brand-blue"/> support@mbtech.ng</li>
                                </ul>
                            </div>
                        </div>
                        <div className="text-center text-xs font-medium">
                            <p>&copy; {new Date().getFullYear()} Mesobest Technology. All rights reserved.</p>
                        </div>
                    </div>
                </footer>
            );
        }

        function OrderDetailsModal({ order, onClose, onUpdateStatus, onUpdatePaymentStatus }) {
            if (!order) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white rounded-[2rem] shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">
                        <div className="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <div>
                                <h3 className="text-xl font-extrabold text-brand-dark">Order Details</h3>
                                <p className="text-sm text-slate-500 font-medium mt-1">ID: {order.id}</p>
                            </div>
                            <button onClick={onClose} className="p-2 bg-white rounded-full text-slate-400 hover:text-slate-700 shadow-sm transition-colors"><XCircle size={24}/></button>
                        </div>
                        <div className="p-8 overflow-y-auto flex-1 space-y-8">
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Customer</h4>
                                    <p className="font-extrabold text-slate-900 text-lg mb-1">{order.userName}</p>
                                    <p className="text-sm text-slate-600 flex items-center gap-2 mb-1"><Phone size={14} className="text-brand-blue"/> {order.contact}</p>
                                    <p className="text-sm text-slate-600 flex items-start gap-2"><MapPin size={14} className="text-brand-orange mt-0.5 shrink-0"/> {order.address}</p>
                                </div>
                                <div className="bg-blue-50 p-5 rounded-2xl border border-blue-100 flex flex-col">
                                    <h4 className="text-xs font-bold text-brand-blue uppercase tracking-wider mb-3">Payment Info</h4>
                                    <p className="font-extrabold text-brand-dark text-2xl mb-2">₦{(order.total || 0).toLocaleString()}</p>
                                    <div className="flex items-center gap-2 text-sm font-bold text-slate-700 mb-2">
                                        <CreditCard size={16} className="text-brand-blue"/> Method: <span className="uppercase">{order.method}</span>
                                    </div>
                                    <div className="flex items-center justify-between mt-auto pt-3 border-t border-blue-200/50">
                                        <div className="flex items-center gap-2 text-sm font-bold">
                                            <ShieldCheck size={16} className={order.paymentStatus === 'paid' ? 'text-emerald-500' : 'text-amber-500'}/>
                                            <span className={order.paymentStatus === 'paid' ? 'text-emerald-600 uppercase' : 'text-amber-600 uppercase'}>{order.paymentStatus || 'pending'}</span>
                                        </div>
                                        <button 
                                            onClick={() => onUpdatePaymentStatus(order.id, order.paymentStatus === 'paid' ? 'pending' : 'paid')}
                                            className="text-[10px] font-bold uppercase tracking-wider bg-white px-2 py-1 rounded shadow-sm text-slate-600 hover:text-brand-blue transition-colors"
                                        >
                                            Toggle
                                        </button>
                                    </div>
                                    {order.paymentReference && (
                                        <div className="mt-3 text-[10px] font-mono bg-white p-2 rounded border border-blue-100 text-slate-500 break-all">
                                            Ref: {order.paymentReference}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div>
                                <h4 className="font-extrabold text-slate-900 mb-4 flex items-center gap-2"><ShoppingBag size={18} className="text-brand-blue"/> Order Items</h4>
                                <div className="space-y-3">
                                    {(order.items || []).map((item, idx) => (
                                        <div key={idx} className="flex justify-between items-center p-4 border border-slate-100 rounded-xl bg-white shadow-sm">
                                            <div className="flex items-center gap-4">
                                                <div className="w-12 h-12 bg-slate-100 rounded-lg overflow-hidden shrink-0">
                                                    <img src={item.image} className="w-full h-full object-cover" onError={(e)=>{e.target.style.display='none'}}/>
                                                </div>
                                                <div>
                                                    <p className="font-bold text-slate-800 line-clamp-1">{item.name}</p>
                                                    <p className="text-sm text-slate-500">Qty: {item.qty}</p>
                                                </div>
                                            </div>
                                            <p className="font-extrabold text-brand-dark">₦{(item.price * item.qty).toLocaleString()}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <h4 className="font-extrabold text-slate-900 mb-4 flex items-center gap-2"><Package size={18} className="text-brand-orange"/> Fulfillment Status</h4>
                                <div className="flex flex-wrap sm:flex-nowrap gap-3">
                                    {['pending', 'processing', 'completed', 'cancelled'].map(status => (
                                        <button 
                                            key={status} 
                                            onClick={() => onUpdateStatus(order.id, status)}
                                            className={`flex-1 py-3 px-2 rounded-xl font-bold text-xs sm:text-sm uppercase tracking-wider border transition-all ${order.status === status ? 'bg-brand-dark text-white border-brand-dark shadow-md' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}
                                        >
                                            {status}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- MAIN APP ---
        function App() {
            const [hasAdminAccess, setHasAdminAccess] = useState(false);
            const [isAuthenticating, setIsAuthenticating] = useState(false);
            const [authError, setAuthError] = useState('');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            
            const [activeTab, setActiveTab] = useState('overview');
            const [orders, setOrders] = useState([]);
            const [leads, setLeads] = useState([]);
            
            const [toast, setToast] = useState(null);
            const [selectedOrder, setSelectedOrder] = useState(null);
            
            // Email Campaign State
            const [selectedEmails, setSelectedEmails] = useState(new Set());
            const [campaignSubject, setCampaignSubject] = useState('');
            const [campaignBody, setCampaignBody] = useState('');

            // Auth Listener
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user && !user.isAnonymous) {
                        setHasAdminAccess(true);
                    } else {
                        setHasAdminAccess(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            // Data Fetching
            useEffect(() => {
                if (!hasAdminAccess) return;

                const qOrders = collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_orders');
                const unsubOrders = onSnapshot(qOrders, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    data.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setOrders(data);
                });

                const qLeads = collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_connect_leads');
                const unsubLeads = onSnapshot(qLeads, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    data.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setLeads(data);
                });

                return () => { unsubOrders(); unsubLeads(); };
            }, [hasAdminAccess]);

            // Compile unified customer list
            const customers = useMemo(() => {
                const map = new Map();
                
                // Add leads (has email)
                leads.forEach(l => {
                    if (l.email) {
                        map.set(l.email.toLowerCase(), { name: l.name, email: l.email, phone: l.phone, source: 'Connect Lead', date: l.createdAt });
                    }
                });
                
                // Add order customers
                orders.forEach(o => {
                    if (o.email) {
                        if (!map.has(o.email.toLowerCase())) {
                            map.set(o.email.toLowerCase(), { name: o.userName, email: o.email, phone: o.contact, source: 'Store Customer', date: o.createdAt });
                        } else {
                            map.get(o.email.toLowerCase()).source = 'Customer & Lead';
                        }
                    }
                });
                return Array.from(map.values()).sort((a,b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
            }, [orders, leads]);

            // Handlers
            const showToast = (msg, type='success') => setToast({message: msg, type});
            
            const handleLogin = async (e) => {
                e.preventDefault();
                setIsAuthenticating(true);
                setAuthError('');

                // Automatically format username to email if necessary
                let loginEmail = username.trim();
                if (!loginEmail.includes('@')) {
                    loginEmail = `${loginEmail}@mbtech.ng`;
                }

                try {
                    await signInWithEmailAndPassword(auth, loginEmail, password);
                    // onAuthStateChanged will handle setting hasAdminAccess to true
                } catch (err) {
                    let errorMessage = err.message.replace('Firebase: ', '');
                    if (err.code === 'auth/invalid-credential') {
                        errorMessage = "Invalid username or password.";
                    } else if (err.code === 'auth/user-not-found') {
                        errorMessage = "Admin user not found.";
                    } else if (err.code === 'auth/wrong-password') {
                        errorMessage = "Incorrect password.";
                    } else if (err.code === 'auth/too-many-requests') {
                        errorMessage = "Too many attempts. Please try again later.";
                    }
                    setAuthError(errorMessage);
                }
                setIsAuthenticating(false);
            };

            const handleLogout = async () => {
                await signOut(auth);
                setHasAdminAccess(false);
            };

            const updateOrderStatus = async (orderId, newStatus) => {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_orders', orderId);
                    await updateDoc(docRef, { status: newStatus });
                    showToast(`Order status updated to ${newStatus}`);
                    setSelectedOrder(prev => prev ? {...prev, status: newStatus} : null);
                } catch (e) { showToast(e.message, 'error'); }
            };

            const updatePaymentStatus = async (orderId, newStatus) => {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_orders', orderId);
                    await updateDoc(docRef, { paymentStatus: newStatus });
                    showToast(`Payment status updated to ${newStatus}`);
                    setSelectedOrder(prev => prev ? {...prev, paymentStatus: newStatus} : null);
                } catch (e) { showToast(e.message, 'error'); }
            };

            const handleEmailCampaign = () => {
                if (selectedEmails.size === 0) { showToast("Select at least one customer", "error"); return; }
                if (!campaignSubject || !campaignBody) { showToast("Subject and Body are required", "error"); return; }

                const bccList = Array.from(selectedEmails).join(',');
                const mailtoLink = `mailto:?bcc=${encodeURIComponent(bccList)}&subject=${encodeURIComponent(campaignSubject)}&body=${encodeURIComponent(campaignBody)}`;
                window.open(mailtoLink, '_blank');
                showToast("Email client opened successfully!");
            };

            const toggleEmailSelection = (email) => {
                const newSet = new Set(selectedEmails);
                if (newSet.has(email)) newSet.delete(email);
                else newSet.add(email);
                setSelectedEmails(newSet);
            };

            const selectAllEmails = () => {
                if (selectedEmails.size === customers.length) setSelectedEmails(new Set());
                else setSelectedEmails(new Set(customers.map(c => c.email)));
            };

            // --- GOOGLE CONTACTS CSV EXPORT / IMPORT ---
            const handleExportCSV = () => {
                const headers = ["Name", "E-mail 1 - Value", "Phone 1 - Value", "Notes"];
                const rows = customers.map(c => [
                    `"${c.name || 'Unknown'}"`,
                    `"${c.email || ''}"`,
                    `"${c.phone || ''}"`,
                    `"Source: ${c.source || 'CRM'}"`
                ]);

                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows.map(e => e.join(","))].join("\n");
                const encodedUri = encodeURI(csvContent);
                
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "mbtech_google_contacts.csv");
                document.body.appendChild(link);
                link.click();
                link.remove();
                
                showToast("Contacts exported for Google successfully!");
            };

            const handleImportCSV = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const lines = text.split('\n');
                    let count = 0;

                    if(lines.length > 0) {
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
                        
                        const nameIdx = headers.findIndex(h => h.includes('name'));
                        const emailIdx = headers.findIndex(h => h.includes('e-mail') || h.includes('email'));
                        const phoneIdx = headers.findIndex(h => h.includes('phone'));
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            
                            const row = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || lines[i].split(',');
                            const cleanVal = (val) => val ? val.replace(/"/g, '').trim() : '';
                            
                            const name = nameIdx !== -1 ? cleanVal(row[nameIdx]) : 'Imported Contact';
                            const email = emailIdx !== -1 ? cleanVal(row[emailIdx]) : '';
                            const phone = phoneIdx !== -1 ? cleanVal(row[phoneIdx]) : '';
                            
                            if (email || phone) {
                                try {
                                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_connect_leads'), {
                                        name: name,
                                        email: email,
                                        phone: phone,
                                        status: 'Imported',
                                        skill: 'N/A',
                                        createdAt: serverTimestamp()
                                    });
                                    count++;
                                } catch(err) { console.error("Error importing row:", err); }
                            }
                        }
                    }
                    showToast(`Successfully imported ${count} contacts into database!`);
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            // --- RENDER LOGIN ---
            if (!hasAdminAccess) {
                return (
                    <div className="flex-1 flex items-center justify-center p-4 py-20 bg-slate-50 font-sans">
                        <div className="bg-white p-8 sm:p-10 rounded-[2rem] shadow-2xl w-full max-w-md border border-slate-100 animate-in fade-in zoom-in-95">
                            <div className="text-center mb-8">
                                <div className="w-16 h-16 bg-brand-blue/10 text-brand-blue rounded-2xl flex items-center justify-center mx-auto mb-4">
                                    <Lock size={32}/>
                                </div>
                                <h1 className="text-3xl font-extrabold text-brand-dark mb-2 tracking-tight">Admin Portal</h1>
                                <p className="text-slate-500 text-sm">Secure Access Required</p>
                            </div>

                            <form onSubmit={handleLogin} className="space-y-5">
                                <div>
                                    <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2 ml-1">Username or Email</label>
                                    <input 
                                        type="text" 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)} 
                                        placeholder="admin" 
                                        required 
                                        className="w-full px-5 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-blue/30 focus:border-brand-blue outline-none text-slate-800 transition-all font-bold"
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2 ml-1">Password</label>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                        placeholder="••••••••" 
                                        required 
                                        className="w-full px-5 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-blue/30 focus:border-brand-blue outline-none text-slate-800 transition-all font-bold"
                                    />
                                </div>

                                {authError && (
                                    <div className="text-red-600 text-sm font-bold text-center bg-red-50 p-3 rounded-xl border border-red-100 flex items-center justify-center gap-2">
                                        <ShieldAlert size={16}/> {authError}
                                    </div>
                                )}

                                <button 
                                    type="submit" 
                                    disabled={isAuthenticating} 
                                    className="w-full py-4 mt-2 bg-brand-dark hover:bg-slate-800 text-white rounded-xl font-bold shadow-lg transition-all flex items-center justify-center gap-2"
                                >
                                    {isAuthenticating ? <Loader2 className="animate-spin"/> : <Lock size={18}/>} 
                                    Login to CRM
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            // --- RENDER CRM DASHBOARD ---
            const revenue = orders.filter(o => o.status !== 'cancelled').reduce((acc, o) => acc + (o.total || 0), 0);
            
            return (
                <div className="flex-1 flex flex-col font-sans bg-[#f8fafc] min-h-screen">
                    <nav className="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between h-16 sm:h-20 items-center">
                            <div className="flex items-center gap-3">
                                <img src="logo.png" alt="MBTECH" className="h-8 sm:h-10 w-auto object-contain" onError={(e)=>{e.target.style.display='none'}}/>
                                <div className="border-l-2 border-slate-200 pl-3">
                                    <h1 className="text-lg sm:text-xl font-extrabold text-brand-dark leading-none">CRM <span className="text-brand-blue">Portal</span></h1>
                                </div>
                            </div>
                            <button onClick={handleLogout} className="text-slate-500 hover:text-red-600 font-bold text-sm flex items-center gap-2 transition-colors bg-slate-50 hover:bg-red-50 px-4 py-2 rounded-lg">
                                <LogOut size={16}/> <span className="hidden sm:inline">Logout</span>
                            </button>
                        </div>
                    </nav>

                    <div className="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex flex-col md:flex-row gap-8">
                        
                        {/* Sidebar Navigation - Responsive Swipeable on Mobile */}
                        <aside className="w-full md:w-64 shrink-0">
                            <div className="bg-white rounded-[2rem] border border-slate-200 p-3 sm:p-4 shadow-sm md:sticky md:top-28 flex overflow-x-auto md:flex-col gap-2 snap-x hide-scrollbar">
                                <button onClick={() => setActiveTab('overview')} className={`snap-start whitespace-nowrap flex-1 md:w-full flex justify-center md:justify-start items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all ${activeTab === 'overview' ? 'bg-brand-blue text-white shadow-md shadow-blue-500/20' : 'text-slate-600 hover:bg-slate-50'}`}>
                                    <LayoutDashboard size={20} className="shrink-0"/> <span className="hidden sm:block md:block">Overview</span>
                                </button>
                                <button onClick={() => setActiveTab('orders')} className={`snap-start whitespace-nowrap flex-1 md:w-full flex justify-center md:justify-start items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all ${activeTab === 'orders' ? 'bg-brand-blue text-white shadow-md shadow-blue-500/20' : 'text-slate-600 hover:bg-slate-50'}`}>
                                    <ShoppingBag size={20} className="shrink-0"/> <span className="hidden sm:block md:block">Orders & Sales</span>
                                </button>
                                <button onClick={() => setActiveTab('customers')} className={`snap-start whitespace-nowrap flex-1 md:w-full flex justify-center md:justify-start items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all ${activeTab === 'customers' ? 'bg-brand-blue text-white shadow-md shadow-blue-500/20' : 'text-slate-600 hover:bg-slate-50'}`}>
                                    <Users size={20} className="shrink-0"/> <span className="hidden sm:block md:block">Customers</span>
                                </button>
                                <button onClick={() => setActiveTab('campaigns')} className={`snap-start whitespace-nowrap flex-1 md:w-full flex justify-center md:justify-start items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all ${activeTab === 'campaigns' ? 'bg-brand-blue text-white shadow-md shadow-blue-500/20' : 'text-slate-600 hover:bg-slate-50'}`}>
                                    <Mail size={20} className="shrink-0"/> <span className="hidden sm:block md:block">Campaigns</span>
                                </button>
                            </div>
                        </aside>

                        {/* Main Content Area */}
                        <main className="flex-1 min-w-0 pb-12">
                            
                            {/* OVERVIEW TAB */}
                            {activeTab === 'overview' && (
                                <div className="space-y-6 animate-in fade-in">
                                    <h2 className="text-3xl font-extrabold text-slate-900 mb-6">Store Performance</h2>
                                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-6">
                                        <div className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                                            <div className="w-12 h-12 bg-blue-50 text-brand-blue rounded-xl flex items-center justify-center mb-4"><ShoppingBag size={24}/></div>
                                            <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Total Orders</p>
                                            <p className="text-3xl font-extrabold text-brand-dark">{orders.length}</p>
                                        </div>
                                        <div className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                                            <div className="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center mb-4"><CreditCard size={24}/></div>
                                            <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Gross Revenue</p>
                                            <p className="text-3xl font-extrabold text-brand-dark">₦{revenue.toLocaleString()}</p>
                                        </div>
                                        <div className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                                            <div className="w-12 h-12 bg-orange-50 text-brand-orange rounded-xl flex items-center justify-center mb-4"><Users size={24}/></div>
                                            <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Unique Contacts</p>
                                            <p className="text-3xl font-extrabold text-brand-dark">{customers.length}</p>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white p-8 rounded-[2rem] border border-slate-200 shadow-sm mt-8">
                                        <h3 className="font-extrabold text-xl text-slate-900 mb-4">Paystack Integration Ready</h3>
                                        <p className="text-slate-600 mb-6">Your CRM is perfectly structured to handle automated payments. The payment dashboard captures <b>Transaction References</b> and allows for manual overrides on Bank Transfers.</p>
                                        <div className="flex items-center gap-4 bg-slate-50 p-4 rounded-xl border border-slate-100">
                                            <ShieldCheck className="text-emerald-500 shrink-0"/>
                                            <span className="text-sm font-bold text-slate-700">Order Data Model contains <code className="bg-white px-2 py-1 rounded border text-brand-blue">paymentReference</code> and <code className="bg-white px-2 py-1 rounded border text-brand-blue">paymentStatus</code> fields.</span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* ORDERS TAB */}
                            {activeTab === 'orders' && (
                                <div className="space-y-6 animate-in fade-in">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-2">
                                        <h2 className="text-3xl font-extrabold text-slate-900">Order Management</h2>
                                    </div>
                                    
                                    <div className="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left border-collapse min-w-[800px]">
                                                <thead>
                                                    <tr className="bg-slate-50 text-slate-500 text-[10px] uppercase tracking-widest border-b border-slate-200">
                                                        <th className="p-6 font-bold">Order ID & Date</th>
                                                        <th className="p-6 font-bold">Customer</th>
                                                        <th className="p-6 font-bold">Amount & Payment</th>
                                                        <th className="p-6 font-bold">Fulfillment</th>
                                                        <th className="p-6 font-bold text-right">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {orders.map(order => (
                                                        <tr key={order.id} className="hover:bg-slate-50 transition-colors">
                                                            <td className="p-6">
                                                                <p className="font-bold text-slate-900 text-sm">#{order.id.slice(-6).toUpperCase()}</p>
                                                                <p className="text-xs text-slate-500 mt-1 flex items-center gap-1"><Clock size={12}/> {order.createdAt?.seconds ? new Date(order.createdAt.seconds*1000).toLocaleDateString() : 'Recent'}</p>
                                                            </td>
                                                            <td className="p-6">
                                                                <p className="font-bold text-slate-800 text-sm">{order.userName}</p>
                                                                <p className="text-xs text-slate-500 mt-0.5">{order.contact}</p>
                                                            </td>
                                                            <td className="p-6">
                                                                <div className="font-extrabold text-brand-dark text-sm">₦{(order.total||0).toLocaleString()}</div>
                                                                <div className={`text-[10px] font-bold uppercase mt-1 ${order.paymentStatus === 'paid' ? 'text-emerald-600' : 'text-amber-500'}`}>
                                                                    {order.paymentStatus || 'PENDING'}
                                                                </div>
                                                            </td>
                                                            <td className="p-6">
                                                                <span className={`text-[10px] font-extrabold uppercase tracking-wider px-3 py-1.5 rounded-lg ${
                                                                    order.status === 'completed' ? 'bg-emerald-100 text-emerald-700' :
                                                                    order.status === 'processing' ? 'bg-blue-100 text-blue-700' :
                                                                    order.status === 'cancelled' ? 'bg-red-100 text-red-700' :
                                                                    'bg-amber-100 text-amber-700'
                                                                }`}>
                                                                    {order.status || 'pending'}
                                                                </span>
                                                            </td>
                                                            <td className="p-6 text-right">
                                                                <button onClick={() => setSelectedOrder(order)} className="px-4 py-2 bg-white border border-slate-200 text-slate-700 font-bold text-xs rounded-xl shadow-sm hover:border-brand-blue hover:text-brand-blue transition-colors">Manage</button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {orders.length === 0 && (
                                                        <tr><td colSpan="5" className="p-16 text-center text-slate-500 font-medium">No orders found.</td></tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* CUSTOMERS TAB */}
                            {activeTab === 'customers' && (
                                <div className="space-y-6 animate-in fade-in">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                                        <h2 className="text-3xl font-extrabold text-slate-900">Customer Database</h2>
                                        <div className="flex flex-wrap gap-3 w-full sm:w-auto">
                                            <label className="flex-1 sm:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-white border border-slate-200 text-slate-700 font-bold rounded-xl shadow-sm hover:bg-slate-50 cursor-pointer transition-colors text-sm">
                                                <UploadCloud size={16}/> Import CSV
                                                <input type="file" accept=".csv" className="hidden" onChange={handleImportCSV} />
                                            </label>
                                            <button onClick={handleExportCSV} className="flex-1 sm:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-brand-dark text-white font-bold rounded-xl shadow-sm hover:bg-slate-800 transition-colors text-sm">
                                                <Download size={16}/> Export (Google)
                                            </button>
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left border-collapse min-w-[700px]">
                                                <thead>
                                                    <tr className="bg-slate-50 text-slate-500 text-[10px] uppercase tracking-widest border-b border-slate-200">
                                                        <th className="p-6 font-bold">Contact Name</th>
                                                        <th className="p-6 font-bold">Email Address</th>
                                                        <th className="p-6 font-bold">Phone Number</th>
                                                        <th className="p-6 font-bold">Origin</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {customers.map((c, i) => (
                                                        <tr key={i} className="hover:bg-slate-50 transition-colors">
                                                            <td className="p-6 font-extrabold text-slate-900 text-sm flex items-center gap-3">
                                                                <div className="w-8 h-8 rounded-full bg-brand-blue/10 text-brand-blue flex items-center justify-center font-bold shrink-0">{c.name.charAt(0)}</div>
                                                                <span className="truncate">{c.name}</span>
                                                            </td>
                                                            <td className="p-6 font-medium text-slate-600 text-sm"><a href={`mailto:${c.email}`} className="hover:text-brand-blue hover:underline">{c.email}</a></td>
                                                            <td className="p-6 font-medium text-slate-600 text-sm">{c.phone || 'N/A'}</td>
                                                            <td className="p-6">
                                                                <span className="text-[10px] font-bold uppercase tracking-wider bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg">{c.source}</span>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {customers.length === 0 && (
                                                        <tr><td colSpan="4" className="p-16 text-center text-slate-500 font-medium">No customer profiles aggregated yet.</td></tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* CAMPAIGNS TAB */}
                            {activeTab === 'campaigns' && (
                                <div className="space-y-6 animate-in fade-in">
                                    <h2 className="text-3xl font-extrabold text-slate-900 mb-6">Bulk Email Campaigns</h2>
                                    
                                    <div className="grid lg:grid-cols-3 gap-8">
                                        <div className="lg:col-span-1 bg-white rounded-[2rem] border border-slate-200 shadow-sm p-6 lg:max-h-[600px] flex flex-col">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="font-extrabold text-slate-900">Select Recipients</h3>
                                                <button onClick={selectAllEmails} className="text-xs font-bold text-brand-blue hover:underline">
                                                    {selectedEmails.size === customers.length ? 'Deselect All' : 'Select All'}
                                                </button>
                                            </div>
                                            <div className="text-xs text-slate-500 mb-4 bg-slate-50 p-3 rounded-xl font-medium border border-slate-100">
                                                Emails are sent using your device's native client via BCC to protect privacy.
                                            </div>
                                            <div className="flex-1 overflow-y-auto space-y-2 pr-2 hide-scrollbar max-h-64 lg:max-h-full">
                                                {customers.map((c, i) => (
                                                    <label key={i} className="flex items-center gap-3 p-3 rounded-xl border border-slate-100 hover:bg-slate-50 cursor-pointer transition-colors">
                                                        <input 
                                                            type="checkbox" 
                                                            checked={selectedEmails.has(c.email)} 
                                                            onChange={() => toggleEmailSelection(c.email)}
                                                            className="w-4 h-4 text-brand-blue rounded border-slate-300 focus:ring-brand-blue"
                                                        />
                                                        <div className="overflow-hidden">
                                                            <p className="text-sm font-bold text-slate-800 truncate">{c.name}</p>
                                                            <p className="text-xs text-slate-500 truncate">{c.email}</p>
                                                        </div>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="lg:col-span-2 bg-white rounded-[2rem] border border-slate-200 shadow-sm p-6 sm:p-8 flex flex-col">
                                            <h3 className="font-extrabold text-xl text-slate-900 mb-6">Compose Message</h3>
                                            
                                            <div className="space-y-5 flex-1 flex flex-col">
                                                <div>
                                                    <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">Subject Line</label>
                                                    <input 
                                                        value={campaignSubject}
                                                        onChange={e => setCampaignSubject(e.target.value)}
                                                        className="w-full border border-slate-200 bg-slate-50 p-4 rounded-xl font-bold text-slate-900 focus:ring-2 focus:ring-brand-blue outline-none transition-shadow" 
                                                        placeholder="e.g. Huge Discounts on Solar Tech!"
                                                    />
                                                </div>
                                                <div className="flex-1 flex flex-col">
                                                    <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">Email Body</label>
                                                    <textarea 
                                                        value={campaignBody}
                                                        onChange={e => setCampaignBody(e.target.value)}
                                                        className="w-full flex-1 min-h-[250px] border border-slate-200 bg-slate-50 p-4 rounded-xl text-slate-700 focus:ring-2 focus:ring-brand-blue outline-none transition-shadow resize-none leading-relaxed" 
                                                        placeholder="Write your newsletter or promotional update here..."
                                                    ></textarea>
                                                </div>
                                            </div>
                                            
                                            <div className="mt-6 flex flex-col sm:flex-row items-start sm:items-center justify-between border-t border-slate-100 pt-6 gap-4">
                                                <div className="text-sm font-bold text-slate-500 flex items-center gap-2">
                                                    <Users size={18} className="text-brand-blue"/> {selectedEmails.size} Recipients Selected
                                                </div>
                                                <button onClick={handleEmailCampaign} className="w-full sm:w-auto px-8 py-4 bg-brand-dark text-white rounded-xl font-bold shadow-lg hover:bg-slate-800 transition-all flex items-center justify-center gap-2">
                                                    <Send size={18}/> Launch Campaign
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                        </main>
                    </div>
                    
                    <OrderDetailsModal order={selectedOrder} onClose={() => setSelectedOrder(null)} onUpdateStatus={updateOrderStatus} onUpdatePaymentStatus={updatePaymentStatus} />
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    <GlobalFooter />
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
