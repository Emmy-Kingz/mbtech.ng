<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MBTECH CRM | Customer & Order Management</title>
    
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { 
                        brand: { 
                            blue: '#0056b3', 
                            blueHover: '#004494', 
                            orange: '#f97316',
                            dark: '#0f172a'
                        } 
                    }
                }
            }
        }
    </script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f8fafc; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-800 antialiased min-h-screen flex flex-col">
    <div id="root" class="flex-1 flex flex-col"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            LayoutDashboard, Users, ShoppingBag, Mail, Lock, LogOut, Check,
            ShieldAlert, Loader2, CreditCard, Search, Filter, Phone, MapPin,
            ExternalLink, Clock, Package, CheckCircle, XCircle, Send, ShieldCheck
        } from 'lucide-react';

        // --- FIREBASE IMPORTS ---
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from 'firebase/auth';
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc } from 'firebase/firestore';

        const firebaseConfig = {
            apiKey: "AIzaSyDRkEVsI2swGV5cgn_0gMHTIWUbLhsacfY",
            authDomain: "mbtechstore-17984.firebaseapp.com",
            projectId: "mbtechstore-17984",
            storageBucket: "mbtechstore-17984.firebasestorage.app",
            messagingSenderId: "1083008774596",
            appId: "1:1083008774596:web:110b651c6426116ed43491"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'mbtech-public-store';

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- COMPONENTS ---
        function OrderDetailsModal({ order, onClose, onUpdateStatus, onUpdatePaymentStatus }) {
            if (!order) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white rounded-[2rem] shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">
                        <div className="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <div>
                                <h3 className="text-xl font-extrabold text-brand-dark">Order Details</h3>
                                <p className="text-sm text-slate-500 font-medium mt-1">ID: {order.id}</p>
                            </div>
                            <button onClick={onClose} className="p-2 bg-white rounded-full text-slate-400 hover:text-slate-700 shadow-sm transition-colors"><ShieldAlert className="hidden"/><XCircle size={24}/></button>
                        </div>
                        <div className="p-8 overflow-y-auto flex-1 space-y-8">
                            
                            <div className="grid grid-cols-2 gap-6">
                                <div className="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Customer</h4>
                                    <p className="font-extrabold text-slate-900 text-lg mb-1">{order.userName}</p>
                                    <p className="text-sm text-slate-600 flex items-center gap-2 mb-1"><Phone size={14} className="text-brand-blue"/> {order.contact}</p>
                                    <p className="text-sm text-slate-600 flex items-start gap-2"><MapPin size={14} className="text-brand-orange mt-0.5 shrink-0"/> {order.address}</p>
                                </div>
                                <div className="bg-blue-50 p-5 rounded-2xl border border-blue-100 flex flex-col">
                                    <h4 className="text-xs font-bold text-brand-blue uppercase tracking-wider mb-3">Payment Info</h4>
                                    <p className="font-extrabold text-brand-dark text-2xl mb-2">₦{(order.total || 0).toLocaleString()}</p>
                                    <div className="flex items-center gap-2 text-sm font-bold text-slate-700 mb-2">
                                        <CreditCard size={16} className="text-brand-blue"/> Method: <span className="uppercase">{order.method}</span>
                                    </div>
                                    <div className="flex items-center justify-between mt-auto pt-3 border-t border-blue-200/50">
                                        <div className="flex items-center gap-2 text-sm font-bold">
                                            <ShieldCheck size={16} className={order.paymentStatus === 'paid' ? 'text-emerald-500' : 'text-amber-500'}/>
                                            <span className={order.paymentStatus === 'paid' ? 'text-emerald-600 uppercase' : 'text-amber-600 uppercase'}>{order.paymentStatus || 'pending'}</span>
                                        </div>
                                        <button 
                                            onClick={() => onUpdatePaymentStatus(order.id, order.paymentStatus === 'paid' ? 'pending' : 'paid')}
                                            className="text-[10px] font-bold uppercase tracking-wider bg-white px-2 py-1 rounded shadow-sm text-slate-600 hover:text-brand-blue transition-colors"
                                        >
                                            Toggle
                                        </button>
                                    </div>
                                    {order.paymentReference && (
                                        <div className="mt-3 text-[10px] font-mono bg-white p-2 rounded border border-blue-100 text-slate-500 break-all">
                                            Ref: {order.paymentReference}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div>
                                <h4 className="font-extrabold text-slate-900 mb-4 flex items-center gap-2"><ShoppingBag size={18} className="text-brand-blue"/> Order Items</h4>
                                <div className="space-y-3">
                                    {(order.items || []).map((item, idx) => (
                                        <div key={idx} className="flex justify-between items-center p-4 border border-slate-100 rounded-xl bg-white shadow-sm">
                                            <div className="flex items-center gap-4">
                                                <div className="w-12 h-12 bg-slate-100 rounded-lg overflow-hidden shrink-0">
                                                    <img src={item.image} className="w-full h-full object-cover" onError={(e)=>{e.target.style.display='none'}}/>
                                                </div>
                                                <div>
                                                    <p className="font-bold text-slate-800 line-clamp-1">{item.name}</p>
                                                    <p className="text-sm text-slate-500">Qty: {item.qty}</p>
                                                </div>
                                            </div>
                                            <p className="font-extrabold text-brand-dark">₦{(item.price * item.qty).toLocaleString()}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <h4 className="font-extrabold text-slate-900 mb-4 flex items-center gap-2"><Package size={18} className="text-brand-orange"/> Fulfillment Status</h4>
                                <div className="flex gap-3">
                                    {['pending', 'processing', 'completed', 'cancelled'].map(status => (
                                        <button 
                                            key={status} 
                                            onClick={() => onUpdateStatus(order.id, status)}
                                            className={`flex-1 py-3 rounded-xl font-bold text-sm uppercase tracking-wider border transition-all ${order.status === status ? 'bg-brand-dark text-white border-brand-dark shadow-md' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}
                                        >
                                            {status}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- MAIN APP ---
        function App() {
            const [hasAdminAccess, setHasAdminAccess] = useState(false);
            const [isAuthenticating, setIsAuthenticating] = useState(false);
            const [authError, setAuthError] = useState('');
            const [passcode, setPasscode] = useState('');
            
            const [activeTab, setActiveTab] = useState('overview');
            const [orders, setOrders] = useState([]);
            const [leads, setLeads] = useState([]);
            
            const [toast, setToast] = useState(null);
            const [selectedOrder, setSelectedOrder] = useState(null);
            
            // Email Campaign State
            const [selectedEmails, setSelectedEmails] = useState(new Set());
            const [campaignSubject, setCampaignSubject] = useState('');
            const [campaignBody, setCampaignBody] = useState('');

            // Auth init
            useEffect(() => {
                signInAnonymously(auth).catch(e => console.warn(e));
            }, []);

            // Data Fetching
            useEffect(() => {
                if (!hasAdminAccess) return;

                const qOrders = collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_orders');
                const unsubOrders = onSnapshot(qOrders, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    data.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setOrders(data);
                });

                const qLeads = collection(db, 'artifacts', appId, 'public', 'data', 'mbtech_connect_leads');
                const unsubLeads = onSnapshot(qLeads, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    data.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setLeads(data);
                });

                return () => { unsubOrders(); unsubLeads(); };
            }, [hasAdminAccess]);

            // Compile unified customer list
            const customers = useMemo(() => {
                const map = new Map();
                
                // Add leads (has email)
                leads.forEach(l => {
                    if (l.email) {
                        map.set(l.email.toLowerCase(), { name: l.name, email: l.email, phone: l.phone, source: 'Connect Lead', date: l.createdAt });
                    }
                });
                
                // Add order customers (might not have email, but we try)
                orders.forEach(o => {
                    // In a real app we'd capture email during checkout. If not, we skip for email campaigns.
                    if (o.email) {
                        if (!map.has(o.email.toLowerCase())) {
                            map.set(o.email.toLowerCase(), { name: o.userName, email: o.email, phone: o.contact, source: 'Store Customer', date: o.createdAt });
                        } else {
                            map.get(o.email.toLowerCase()).source = 'Customer & Lead';
                        }
                    }
                });
                return Array.from(map.values()).sort((a,b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
            }, [orders, leads]);

            // Auth Handlers
            const handleGoogleLogin = async () => {
                setIsAuthenticating(true);
                try {
                    const provider = new GoogleAuthProvider();
                    const result = await signInWithPopup(auth, provider);
                    const allowedEmails = ['emmanuel.amobi03@gmail.com', 'mesobest.technology.org@gmail.com', 'mesobest2000@gmail.com'];
                    
                    if (result.user.email && allowedEmails.includes(result.user.email.toLowerCase())) {
                        setHasAdminAccess(true); setAuthError('');
                    } else {
                        setAuthError('Unauthorized Account. Admin privileges required.');
                        await signOut(auth); await signInAnonymously(auth);
                    }
                } catch (err) { setAuthError(err.message.replace('Firebase: ', '')); }
                setIsAuthenticating(false);
            };

            const handlePasscodeLogin = async (e) => {
                e.preventDefault();
                setIsAuthenticating(true);
                const lockTime = parseInt(localStorage.getItem('mbtech_admin_lock_time') || '0');
                if (Date.now() < lockTime) {
                    setAuthError(`Locked out. Try again later.`);
                    setIsAuthenticating(false); return;
                }
                const inputHash = await sha256(passcode);
                const storedHash = localStorage.getItem('mbtech_admin_hash') || await sha256('emmy-admin%%');
                
                if (inputHash === storedHash) {
                    setHasAdminAccess(true); setAuthError('');
                } else {
                    setAuthError('Invalid CRM Passcode.');
                }
                setIsAuthenticating(false);
            };

            // Handlers
            const showToast = (msg, type='success') => setToast({message: msg, type});
            
            const updateOrderStatus = async (orderId, newStatus) => {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_orders', orderId);
                    await updateDoc(docRef, { status: newStatus });
                    showToast(`Order status updated to ${newStatus}`);
                    setSelectedOrder(prev => prev ? {...prev, status: newStatus} : null);
                } catch (e) { showToast(e.message, 'error'); }
            };

            const updatePaymentStatus = async (orderId, newStatus) => {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'mbtech_orders', orderId);
                    await updateDoc(docRef, { paymentStatus: newStatus });
                    showToast(`Payment status updated to ${newStatus}`);
                    setSelectedOrder(prev => prev ? {...prev, paymentStatus: newStatus} : null);
                } catch (e) { showToast(e.message, 'error'); }
            };

            const handleEmailCampaign = () => {
                if (selectedEmails.size === 0) { showToast("Select at least one customer", "error"); return; }
                if (!campaignSubject || !campaignBody) { showToast("Subject and Body are required", "error"); return; }

                const bccList = Array.from(selectedEmails).join(',');
                const mailtoLink = `mailto:?bcc=${encodeURIComponent(bccList)}&subject=${encodeURIComponent(campaignSubject)}&body=${encodeURIComponent(campaignBody)}`;
                window.open(mailtoLink, '_blank');
                showToast("Email client opened successfully!");
            };

            const toggleEmailSelection = (email) => {
                const newSet = new Set(selectedEmails);
                if (newSet.has(email)) newSet.delete(email);
                else newSet.add(email);
                setSelectedEmails(newSet);
            };

            const selectAllEmails = () => {
                if (selectedEmails.size === customers.length) setSelectedEmails(new Set());
                else setSelectedEmails(new Set(customers.map(c => c.email)));
            };

            // --- RENDER LOGIN ---
            if (!hasAdminAccess) {
                return (
                    <div className="flex-1 flex items-center justify-center p-4 py-20 bg-slate-50 font-sans">
                        <div className="bg-white p-8 sm:p-10 rounded-[2rem] shadow-2xl w-full max-w-md border border-slate-100">
                            <div className="text-center mb-8">
                                <div className="w-16 h-16 bg-brand-blue/10 text-brand-blue rounded-2xl flex items-center justify-center mx-auto mb-4">
                                    <Users size={32}/>
                                </div>
                                <h1 className="text-3xl font-extrabold text-brand-dark mb-2 tracking-tight">CRM Portal</h1>
                                <p className="text-slate-500 text-sm">Customer Relationship & Order Manager</p>
                            </div>
                            
                            <button onClick={handleGoogleLogin} disabled={isAuthenticating} className="w-full flex items-center justify-center gap-3 py-3.5 px-4 border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors font-bold text-slate-700 mb-5">
                                <svg className="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                                Admin Authenticate
                            </button>

                            <div className="flex items-center gap-3 mb-5">
                                <div className="h-px bg-slate-200 flex-1"></div>
                                <span className="text-[10px] text-slate-400 font-extrabold uppercase tracking-widest">Or Secure Passcode</span>
                                <div className="h-px bg-slate-200 flex-1"></div>
                            </div>

                            <form onSubmit={handlePasscodeLogin} className="space-y-6">
                                <input type="password" value={passcode} onChange={(e) => setPasscode(e.target.value)} placeholder="••••••••" required className="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-blue/30 focus:border-brand-blue outline-none text-center text-xl tracking-[0.5em] text-slate-800 transition-all font-bold"/>
                                {authError && <div className="text-red-500 text-sm font-bold text-center">{authError}</div>}
                                <button type="submit" disabled={isAuthenticating} className="w-full py-4 bg-brand-dark hover:bg-slate-800 text-white rounded-xl font-bold shadow-lg transition-all flex items-center justify-center gap-2">
                                    {isAuthenticating ? <Loader2 className="animate-spin"/> : <Lock size={18}/>} Unlock CRM
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            // --- RENDER CRM DASHBOARD ---
            const revenue = orders.filter(o => o.status !== 'cancelled').reduce((acc, o) => acc + (o.total || 0), 0);
            
            return (
                <div className="flex-1 flex flex-col font-sans bg-[#f8fafc]">
                    <nav className="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between h-16 sm:h-20 items-center">
                            <div className="flex items-center gap-3">
                                <img src="logo.png" alt="MBTECH" className="h-8 sm:h-10 w-auto object-contain" onError={(e)=>{e.target.style.display='none'}}/>
                                <div className="border-l-2 border-slate-200 pl-3">
                                    <h1 className="text-lg sm:text-xl font-extrabold text-brand-dark leading-none">CRM <span className="text-brand-blue">Portal</span></h1>
                                </div>
                            </div>
                            <button onClick={() => { setHasAdminAccess(false); signOut(auth); }} className="text-slate-400 hover:text-red-600 font-bold text-sm flex items-center gap-2 transition-colors bg-slate-50 px-4 py-2 rounded-lg">
                                <LogOut size={16}/> <span className="hidden sm:inline">Logout</span>
                            </button>
                        </div>
                    </nav>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex flex-col md:flex-row gap-8 w-full">
                        
                        {/* Sidebar Navigation */}
                        <aside className="w-full md:w-64 shrink-0">
                            <div className="bg-white rounded-[2rem] border border-slate-200 p-4 shadow-sm sticky top-28 space-y-2">
                                <button onClick={() => setActiveTab('overview')} className={`w-full flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all ${activeTab === 'overview' ? 'bg-brand-blue text-white shadow-md shadow-blue-500/20' : 'text-slate-600 hover:bg-slate-50'}`}>
                                    <LayoutDashboard size={20}/> Overview
                                </button>
                                <button onClick={() => setActiveTab('orders')} className={`w-full flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all ${activeTab === 'orders' ? 'bg-brand-blue text-white shadow-md shadow-blue-500/20' : 'text-slate-600 hover:bg-slate-50'}`}>
                                    <ShoppingBag size={20}/> Orders & Sales
                                </button>
                                <button onClick={() => setActiveTab('customers')} className={`w-full flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all ${activeTab === 'customers' ? 'bg-brand-blue text-white shadow-md shadow-blue-500/20' : 'text-slate-600 hover:bg-slate-50'}`}>
                                    <Users size={20}/> Customers List
                                </button>
                                <button onClick={() => setActiveTab('campaigns')} className={`w-full flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all ${activeTab === 'campaigns' ? 'bg-brand-blue text-white shadow-md shadow-blue-500/20' : 'text-slate-600 hover:bg-slate-50'}`}>
                                    <Mail size={20}/> Email Campaigns
                                </button>
                            </div>
                        </aside>

                        {/* Main Content Area */}
                        <main className="flex-1 min-w-0">
                            
                            {/* OVERVIEW TAB */}
                            {activeTab === 'overview' && (
                                <div className="space-y-6 animate-in fade-in">
                                    <h2 className="text-3xl font-extrabold text-slate-900 mb-6">Store Performance</h2>
                                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-6">
                                        <div className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                                            <div className="w-12 h-12 bg-blue-50 text-brand-blue rounded-xl flex items-center justify-center mb-4"><ShoppingBag size={24}/></div>
                                            <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Total Orders</p>
                                            <p className="text-3xl font-extrabold text-brand-dark">{orders.length}</p>
                                        </div>
                                        <div className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                                            <div className="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center mb-4"><CreditCard size={24}/></div>
                                            <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Gross Revenue</p>
                                            <p className="text-3xl font-extrabold text-brand-dark">₦{revenue.toLocaleString()}</p>
                                        </div>
                                        <div className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                                            <div className="w-12 h-12 bg-orange-50 text-brand-orange rounded-xl flex items-center justify-center mb-4"><Users size={24}/></div>
                                            <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Unique Contacts</p>
                                            <p className="text-3xl font-extrabold text-brand-dark">{customers.length}</p>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white p-8 rounded-[2rem] border border-slate-200 shadow-sm mt-8">
                                        <h3 className="font-extrabold text-xl text-slate-900 mb-4">Paystack Integration Ready</h3>
                                        <p className="text-slate-600 mb-6">Your CRM is now perfectly structured to handle automated payments. The payment dashboard captures <b>Transaction References</b> and allows for manual overrides on Bank Transfers.</p>
                                        <div className="flex items-center gap-4 bg-slate-50 p-4 rounded-xl border border-slate-100">
                                            <ShieldCheck className="text-emerald-500"/>
                                            <span className="text-sm font-bold text-slate-700">Order Data Model contains <code className="bg-white px-2 py-1 rounded border text-brand-blue">paymentReference</code> and <code className="bg-white px-2 py-1 rounded border text-brand-blue">paymentStatus</code> fields.</span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* ORDERS TAB */}
                            {activeTab === 'orders' && (
                                <div className="space-y-6 animate-in fade-in">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-2">
                                        <h2 className="text-3xl font-extrabold text-slate-900">Order Management</h2>
                                    </div>
                                    
                                    <div className="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left border-collapse min-w-[800px]">
                                                <thead>
                                                    <tr className="bg-slate-50 text-slate-500 text-[10px] uppercase tracking-widest border-b border-slate-200">
                                                        <th className="p-6 font-bold">Order ID & Date</th>
                                                        <th className="p-6 font-bold">Customer</th>
                                                        <th className="p-6 font-bold">Amount & Payment</th>
                                                        <th className="p-6 font-bold">Fulfillment</th>
                                                        <th className="p-6 font-bold text-right">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {orders.map(order => (
                                                        <tr key={order.id} className="hover:bg-slate-50 transition-colors">
                                                            <td className="p-6">
                                                                <p className="font-bold text-slate-900 text-sm">#{order.id.slice(-6).toUpperCase()}</p>
                                                                <p className="text-xs text-slate-500 mt-1 flex items-center gap-1"><Clock size={12}/> {order.createdAt?.seconds ? new Date(order.createdAt.seconds*1000).toLocaleDateString() : 'Recent'}</p>
                                                            </td>
                                                            <td className="p-6">
                                                                <p className="font-bold text-slate-800 text-sm">{order.userName}</p>
                                                                <p className="text-xs text-slate-500 mt-0.5">{order.contact}</p>
                                                            </td>
                                                            <td className="p-6">
                                                                <div className="font-extrabold text-brand-dark text-sm">₦{(order.total||0).toLocaleString()}</div>
                                                                <div className={`text-[10px] font-bold uppercase mt-1 ${order.paymentStatus === 'paid' ? 'text-emerald-600' : 'text-amber-500'}`}>
                                                                    {order.paymentStatus || 'PENDING'}
                                                                </div>
                                                            </td>
                                                            <td className="p-6">
                                                                <span className={`text-[10px] font-extrabold uppercase tracking-wider px-3 py-1.5 rounded-lg ${
                                                                    order.status === 'completed' ? 'bg-emerald-100 text-emerald-700' :
                                                                    order.status === 'processing' ? 'bg-blue-100 text-blue-700' :
                                                                    order.status === 'cancelled' ? 'bg-red-100 text-red-700' :
                                                                    'bg-amber-100 text-amber-700'
                                                                }`}>
                                                                    {order.status || 'pending'}
                                                                </span>
                                                            </td>
                                                            <td className="p-6 text-right">
                                                                <button onClick={() => setSelectedOrder(order)} className="px-4 py-2 bg-white border border-slate-200 text-slate-700 font-bold text-xs rounded-xl shadow-sm hover:border-brand-blue hover:text-brand-blue transition-colors">Manage</button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {orders.length === 0 && (
                                                        <tr><td colSpan="5" className="p-16 text-center text-slate-500 font-medium">No orders found.</td></tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* CUSTOMERS TAB */}
                            {activeTab === 'customers' && (
                                <div className="space-y-6 animate-in fade-in">
                                    <h2 className="text-3xl font-extrabold text-slate-900 mb-6">Customer Database</h2>
                                    <div className="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left border-collapse min-w-[700px]">
                                                <thead>
                                                    <tr className="bg-slate-50 text-slate-500 text-[10px] uppercase tracking-widest border-b border-slate-200">
                                                        <th className="p-6 font-bold">Contact Name</th>
                                                        <th className="p-6 font-bold">Email Address</th>
                                                        <th className="p-6 font-bold">Phone Number</th>
                                                        <th className="p-6 font-bold">Origin</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {customers.map((c, i) => (
                                                        <tr key={i} className="hover:bg-slate-50 transition-colors">
                                                            <td className="p-6 font-extrabold text-slate-900 text-sm flex items-center gap-3">
                                                                <div className="w-8 h-8 rounded-full bg-brand-blue/10 text-brand-blue flex items-center justify-center font-bold">{c.name.charAt(0)}</div>
                                                                {c.name}
                                                            </td>
                                                            <td className="p-6 font-medium text-slate-600 text-sm"><a href={`mailto:${c.email}`} className="hover:text-brand-blue hover:underline">{c.email}</a></td>
                                                            <td className="p-6 font-medium text-slate-600 text-sm">{c.phone || 'N/A'}</td>
                                                            <td className="p-6">
                                                                <span className="text-[10px] font-bold uppercase tracking-wider bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg">{c.source}</span>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {customers.length === 0 && (
                                                        <tr><td colSpan="4" className="p-16 text-center text-slate-500 font-medium">No customer profiles aggregated yet.</td></tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* CAMPAIGNS TAB */}
                            {activeTab === 'campaigns' && (
                                <div className="space-y-6 animate-in fade-in">
                                    <h2 className="text-3xl font-extrabold text-slate-900 mb-6">Bulk Email Campaigns</h2>
                                    
                                    <div className="grid lg:grid-cols-3 gap-8">
                                        <div className="lg:col-span-1 bg-white rounded-[2rem] border border-slate-200 shadow-sm p-6 max-h-[600px] flex flex-col">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="font-extrabold text-slate-900">Select Recipients</h3>
                                                <button onClick={selectAllEmails} className="text-xs font-bold text-brand-blue hover:underline">
                                                    {selectedEmails.size === customers.length ? 'Deselect All' : 'Select All'}
                                                </button>
                                            </div>
                                            <div className="text-xs text-slate-500 mb-4 bg-slate-50 p-3 rounded-xl font-medium border border-slate-100">
                                                Emails are sent using your device's native client via BCC to protect privacy.
                                            </div>
                                            <div className="flex-1 overflow-y-auto space-y-2 pr-2 hide-scrollbar">
                                                {customers.map((c, i) => (
                                                    <label key={i} className="flex items-center gap-3 p-3 rounded-xl border border-slate-100 hover:bg-slate-50 cursor-pointer transition-colors">
                                                        <input 
                                                            type="checkbox" 
                                                            checked={selectedEmails.has(c.email)} 
                                                            onChange={() => toggleEmailSelection(c.email)}
                                                            className="w-4 h-4 text-brand-blue rounded border-slate-300 focus:ring-brand-blue"
                                                        />
                                                        <div className="overflow-hidden">
                                                            <p className="text-sm font-bold text-slate-800 truncate">{c.name}</p>
                                                            <p className="text-xs text-slate-500 truncate">{c.email}</p>
                                                        </div>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="lg:col-span-2 bg-white rounded-[2rem] border border-slate-200 shadow-sm p-8 flex flex-col">
                                            <h3 className="font-extrabold text-xl text-slate-900 mb-6">Compose Message</h3>
                                            
                                            <div className="space-y-5 flex-1 flex flex-col">
                                                <div>
                                                    <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">Subject Line</label>
                                                    <input 
                                                        value={campaignSubject}
                                                        onChange={e => setCampaignSubject(e.target.value)}
                                                        className="w-full border border-slate-200 bg-slate-50 p-4 rounded-xl font-bold text-slate-900 focus:ring-2 focus:ring-brand-blue outline-none transition-shadow" 
                                                        placeholder="e.g. Huge Discounts on Solar Tech!"
                                                    />
                                                </div>
                                                <div className="flex-1 flex flex-col">
                                                    <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">Email Body</label>
                                                    <textarea 
                                                        value={campaignBody}
                                                        onChange={e => setCampaignBody(e.target.value)}
                                                        className="w-full flex-1 min-h-[250px] border border-slate-200 bg-slate-50 p-4 rounded-xl text-slate-700 focus:ring-2 focus:ring-brand-blue outline-none transition-shadow resize-none leading-relaxed" 
                                                        placeholder="Write your newsletter or promotional update here..."
                                                    ></textarea>
                                                </div>
                                            </div>
                                            
                                            <div className="mt-6 flex items-center justify-between border-t border-slate-100 pt-6">
                                                <div className="text-sm font-bold text-slate-500 flex items-center gap-2">
                                                    <Users size={18} className="text-brand-blue"/> {selectedEmails.size} Recipients Selected
                                                </div>
                                                <button onClick={handleEmailCampaign} className="px-8 py-4 bg-brand-dark text-white rounded-xl font-bold shadow-lg hover:bg-slate-800 transition-all flex items-center gap-2">
                                                    <Send size={18}/> Launch Campaign
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                        </main>
                    </div>
                    
                    <OrderDetailsModal order={selectedOrder} onClose={() => setSelectedOrder(null)} onUpdateStatus={updateOrderStatus} onUpdatePaymentStatus={updatePaymentStatus} />
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
